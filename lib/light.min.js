!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).LightEngine={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var n=function(){return(n=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function r(t,e,i,n){return new(i||(i=Promise))((function(r,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}h((n=n.apply(t,e||[])).next())}))}function o(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),r=0;for(e=0;e<i;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)n[r]=o[s];return n}var a=new Map,h=function(){function t(){this.events=a}return t.prototype.has=function(t){return this.events.has(t)&&this.get(t).length>0},t.prototype.get=function(t){return this.events.get(t)},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return!!this.has(t)&&(this.events.set(t,(this.get(t)||[]).map((function(t){return t instanceof Array?t[1]?t:(t[0].apply(t,e),[t[0],!0]):(t.apply(void 0,e),t)}))),!0)},t.prototype.on=function(t,e){return this.events.set(t,s(this.get(t)||[],[e])),this},t.prototype.once=function(t,e){return this.events.set(t,s(this.get(t)||[],[[e,!1]])),this},t.prototype.off=function(t,e){if(!this.has(t))return!1;var i=this.get(t);return!!i&&(this.events.set(t,i.filter((function(t){return t!==e}))),0!==i.length||this.events.delete(t))},t.prototype.offAll=function(t){return t?this.events.set(t,[]):this.events.clear(),!0},t}(),c=function(t){function e(){var e=t.call(this)||this;return e.events=new Map,e}return i(e,t),Object.defineProperty(e.prototype,"globals",{get:function(){return new h},enumerable:!1,configurable:!0}),e}(h),u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=Symbol(null),e}return i(e,t),Object.defineProperty(e,"Types",{get:function(){return this._types},enumerable:!1,configurable:!0}),e.createType=function(t){return this._types[t]=Symbol(t),this},e._types={},e}(c),l=new Map,d=function(t){function e(e,i,n){var r=t.call(this)||this;return r.game=e,r.audio=i,r.key=n,r.isPlaying=!1,r.isPaused=!0,r.isDeleted=!1,r.state={},r.ended=function(){return r.emit("ended")},r.context=r.game.audioContext,r.changePageVisible=r.changePageVisible.bind(r),r.gain=r.context.createGain(),r.gain.connect(r.context.destination),r.source=r.context.createBufferSource(),r.state.started=!1,r.context.decodeAudioData(r.audio.buffer).then((function(t){r.source.buffer=t,r.source.loop=r.loop,r.source.connect(r.gain),r.source.addEventListener("ended",r.ended)})),r.volume=1,r.speed=1,r.loop=!0,r.globals.on("page:visibilitychange",r.changePageVisible),r}return i(e,t),Object.defineProperty(e.prototype,"loop",{get:function(){return this.state.loop},set:function(t){this.source.loop=t,this.state.loop=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.state.volume},set:function(t){this.gain.gain.value=t,this.state.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"speed",{get:function(){return this.state.speed},set:function(t){this.source.playbackRate.value=t,this.state.speed=t},enumerable:!1,configurable:!0}),e.prototype.play=function(){this.isPaused&&(this.state.started?this.context.resume():(this.source.start(),this.state.started=!0),this.emit("played"),this.isPlaying=!0,this.isPaused=!1)},e.prototype.pause=function(){this.isPlaying&&(this.context.suspend(),this.emit("paused"),this.isPaused=!0,this.isPlaying=!1)},e.prototype.toggle=function(){this.isPlaying?this.pause():this.play()},e.prototype.destroy=function(){this.source.removeEventListener("ended",this.ended),this.source.stop(),this.gain.disconnect(),this.source.disconnect(),this.context.close(),this.globals.off("page:visibilitychange",this.changePageVisible),this.audio=null,this.isDeleted=!0},e.prototype.getAudio=function(t){return r(this,void 0,Promise,(function(){var e,i;return o(this,(function(n){switch(n.label){case 0:return l.has(t)?[2,l.get(t)]:[4,fetch(t)];case 1:return[4,n.sent().arrayBuffer()];case 2:return e=n.sent(),[4,this.context.decodeAudioData(e)];case 3:return i=n.sent(),l.set(t,i),[2,i]}}))}))},e.prototype.changePageVisible=function(){document.hidden&&this.isPlaying?this.context.suspend():!document.hidden&&this.isPlaying&&this.context.resume()},e}(u),g=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.clones=[],e}return i(e,t),e.prototype.createClone=function(){var t=new d(this.game,this.audio,this.key);return this.clones.push(t),t},e.prototype.deletion=function(){this.destroy(),this.clones.forEach((function(t){return t.destroy()})),this.clones=[]},e}(d),p=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},f=[["A"],["B"],["X"],["Y"],["Left Bumper","LB"],["Right Bumper","RB"],["Left Trigger","LT"],["Right Trigger","RT"],["Back","View"],["Start"],["Left Stick"],["Right Stick"],["Up","DpadUp"],["Down","DpadDown"],["Left","DpadLeft"],["Right","DpadRight"],["Home","Guide","Xbox"]];var y,m,v,b={left:{label:"Left stick",xAxis:0,yAxis:1},right:{label:"Right stick",xAxis:2,yAxis:3}},x=function(t){function e(e){void 0===e&&(e=navigator);var i=t.call(this)||this;return i.gamepadTimestamp=0,i.navigator=e,i.cgamepad=null,i.store={preferGamepad:!1},i.on("add",(function(t){var e=t.gamepad;if(i.isConnected())return null;"standard"===e.mapping&&(i.cgamepad=e,i.gamepadIndex=e.index,i.store.preferGamepad=!0)})),i.on("remove",(function(t){var e=t.gamepad;if(i.gamepadIndex!==e.index)return null;i.gamepadIndex=void 0,i.store.preferGamepad=!1,i.offAll()})),i}return i(e,t),e.prototype.isConnected=function(){return void 0!==this.gamepadIndex&&this.gamepad.connected},Object.defineProperty(e.prototype,"gamepad",{get:function(){var t=this.navigator.getGamepads()[this.gamepadIndex];return t?(t.timestamp>this.gamepadTimestamp&&(this.store.preferGamepad=!0,this.gamepadTimestamp=t.timestamp),t):this.cgamepad},enumerable:!1,configurable:!0}),e.prototype.button=function(t){var e=this,i=function(t){if("number"==typeof t)return t;for(var e=0,i=0,n=f;i<n.length;i++){for(var r=0,o=n[i];r<o.length;r++){var s=o[r];if(t.toLowerCase()===s.toLowerCase())return e}e++}throw new Error('There is no gamepad button called "'+t+'"!')}(t);return{label:f[i][0],query:function(){return!!e.isConnected()&&e.gamepad.buttons[i].pressed}}},e.prototype.stick=function(t){var e,i=this;if("string"==typeof t){if(!(t in b))throw new Error('Gamepad stick "'+t+'" not found!');e=b[t]}else e=t;return{label:e.label,query:function(){return i.isConnected()?new p(i.gamepad.axes[e.xAxis],i.gamepad.axes[e.yAxis]):new p(0,0)}}},e.prototype.vibrate=function(t,e){var i=void 0===e?{}:e,n=i.weakMagnitude,s=i.strongMagnitude;return r(this,void 0,Promise,(function(){var e;return o(this,(function(i){switch(i.label){case 0:return this.isConnected()&&((e=this.gamepad.vibrationActuator)&&"dual-rumble"===e.type)?[4,e.playEffect("dual-rumble",{duration:t,strongMagnitude:s,weakMagnitude:n})]:[2];case 1:return i.sent(),[2]}}))}))},e}(c);function w(t,e){return"number"==typeof t?t:t.trim().endsWith("px")?Number(t.replace(/px$/,"")):t.trim().endsWith("%")?e*(Number(t.replace(/%$/,""))/100):0}function S(t,e){var i="Mouse"===M(e,!0),n="Circle"===M(e),r=e.x,o=e.y;if(t.beginPath(),t.fillStyle="#f00",t.arc(r+(i?0:e.scene.camera.x),o+(i?0:e.scene.camera.y),2,0,2*Math.PI),t.fill(),t.closePath(),n)e.fixed||t.translate(e.scene.camera.x,e.scene.camera.y),t.translate(e.width*e.getScale().x/-2,e.height*e.getScale().y/-2),t.translate(e.radius*-e.getOrigin().x*e.getScale().r,e.radius*-e.getOrigin().y*e.getScale().r),t.beginPath(),t.lineWidth=2,t.strokeStyle="green",t.arc(r,o,e.radius*e.getScale().r,0,2*Math.PI),t.stroke(),t.closePath();else if(!i){var s=e.getBodyBox();e.fixed||t.translate(e.scene.camera.x,e.scene.camera.y),t.translate(e.width*e.getScale().x/-2,e.height*e.getScale().y/-2),t.translate(e.width/2*-e.getOrigin().x*e.getScale().x,e.height/2*-e.getOrigin().y*e.getScale().y),t.lineWidth=2,t.strokeStyle="green",t.strokeRect(r+s.getX(),o+s.getY(),s.getWidth(),s.getHeight())}t.setTransform(1,0,0,1,0,0)}function P(t){return null!=t}function M(t,e){if(void 0===e&&(e=!1),e)return t.constructor.name;if("object"==typeof t||void 0===t){if(null==t)return"undefined";if(t===Promise.prototype)return"Promise";if(void 0!==t[Symbol.toStringTag])return t[Symbol.toStringTag];var i=Object.prototype.toString.call(t).replace(/\[object (.*)\]/,(function(t,e){return e}));return"global"===i||"Window"===i||"DedicatedWorkerGlobalScope"===i||"WorkerGlobalScope"===i?"global":i}return typeof t}!function(t){t[t.Next=0]="Next",t[t.Prev=1]="Prev"}(y||(y={})),function(t){t[t.Scene=0]="Scene",t[t.Entity=1]="Entity",t[t.Manager=2]="Manager"}(m||(m={})),function(t){t[t.Load=0]="Load",t[t.Audio=1]="Audio",t[t.ClientKey=2]="ClientKey"}(v||(v={}));var O=function(t){function e(e){var i=t.call(this)||this;return i.scene=e,i.list=[],i}return i(e,t),e.prototype.add=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=s(this.list,t.map((function(t){return t instanceof Function?new t:t}))),this},e.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=this.list.filter((function(e){return!t.includes(e)})),this},e.prototype.setManagers=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=t.map((function(t){return t instanceof u?t:new t})),this},e.prototype.getManager=function(t){var e=this.list.find((function(e){return e.name===t}));return e||(this.globals.emit("w"+m.Manager,"this manager "+t+" is not create"),new u)},e.prototype.getAllType=function(t){return this.list.filter((function(e){return e.type.description===t}))},e.prototype.getAll=function(){return this.list},e}(u),_=function(t){function e(e){var i=t.call(this)||this;return i.src=e,fetch(i.src).then((function(t){return t.arrayBuffer()})).then((function(t){i.buffer=t,i.emit("loadeddata")})).catch((function(t){return i.emit("error",t)})),i}return i(e,t),e}(c),k=function(){function t(t,e,i,n,r){this.rebound=!1,"Scene"===M(t)?this.parent=t.world:this.parent=t,this._x=e,this._y=i,this._width=n,this._height=r,this._onlyBorder=!1,this._border={top:0,right:0,bottom:0,left:0}}return Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return"BoundingBox"},enumerable:!1,configurable:!0}),t.prototype.clone=function(){return new t(this.parent,this._x,this._y,this._width,this._height)},t.prototype.getX=function(){if("number"==typeof this._x)return this._x;if("string"==typeof this._x)return w(this._x,this.parent?this.parent.bounds.getWidth():0);var t=this._x.get();return"number"==typeof t?t:"string"==typeof t?w(t,this.parent?this.parent.bounds.getWidth():0):0},t.prototype.setX=function(t){"object"==typeof this._x?this._x.set(t):this._x=t},t.prototype.getY=function(){if("number"==typeof this._y)return this._y;if("string"==typeof this._y)return w(this._y,this.parent?this.parent.bounds.getHeight():0);var t=this._y.get();return"number"==typeof t?t:"string"==typeof t?w(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setY=function(t){"object"==typeof this._y?this._y.set(t):this._y=t},t.prototype.getWidth=function(){if("number"==typeof this._width)return this._width;if("string"==typeof this._width)return w(this._width,this.parent?this.parent.bounds.getWidth():0);var t=this._width.get();return"number"==typeof t?t:"string"==typeof t?w(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setWidth=function(t){"object"==typeof this._width?this._width.set(t):this._width=t},t.prototype.getHeight=function(){if("number"==typeof this._height)return this._height;if("string"==typeof this._height)return w(this._height,this.parent?this.parent.bounds.getHeight():0);var t=this._height.get();return"number"==typeof t?t:"string"==typeof t?w(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setHeight=function(t){"object"==typeof this._height?this._height.set(t):this._height=t},t.prototype.moveEntity=function(t){return t.setBox(this),this},t.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&"rebound"===e&&(this.rebound=t[e])},t.prototype.toJSON=function(){return{x:this.getX(),y:this.getY(),width:this.getWidth(),height:this.getHeight(),rebound:this.rebound}},t}(),W=function(t){function e(e){var i=t.call(this)||this,n=null,r=null,o=null,s=null;return i.isActive=!1,i.bounds=new k(i,{get:function(){return n||e.camera.x},set:function(t){n=t}},{get:function(){return r||e.camera.y},set:function(t){r=t}},{get:function(){return o||e.camera.width},set:function(t){o=t}},{get:function(){return s||e.camera.height},set:function(t){s=t}}),i}return i(e,t),Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return"World"},enumerable:!1,configurable:!0}),e.prototype.activation=function(t){this.isActive=t},e.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("boundingBox"===e?this.bounds.fromSave(t[e]):this[e]!==t[e]&&(this[e]=t[e]))},e.prototype.toJSON=function(){return{isActive:this.isActive,boundingBox:this.bounds}},e}(c),C=function(t){function e(e,i,n){var r,o=t.call(this)||this;o.hidden=!1,o.name="",o.lineWidth=1,o.alpha=1,o.zindex=0,o.fixed=!1,o.originX=0,o.originY=0,o.scalex=1,o.scaley=1,o.bodyBox=null,o.vx=0,o.vy=0,o._speed=1,o._gravity=0,o._bounceWithoutLosingSpeed=!0,o.scene=e,o.box=null===(r=null==e?void 0:e.world)||void 0===r?void 0:r.bounds,o.x=i,o.y=n,o.isMoving=!0;return o.setName(o.constructor.name),o.initBodyBox(e),o.on("move:velocity",(function(t){var e,i,n=.9+(t._bounceWithoutLosingSpeed?.1:0);t.x+=t.vx*t._speed*t.scene.game.secondsPassed,t.y+=t.vy*(t._gravity||t._speed)*t.scene.game.secondsPassed,(null===(i=null===(e=t.box)||void 0===e?void 0:e.parent)||void 0===i?void 0:i.isActive)?"Circle"===M(t)?(t.x-t.box.getX()<t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=Math.abs(t.vx)*n),t.x=t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX+t.box.getX()):t.x-t.box.getX()>t.box.getWidth()+t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=-Math.abs(t.vx)*n),t.x=t.box.getWidth()+t.box.getX()-t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX),t.y-t.box.getY()<t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=Math.abs(t.vy)*n),t.y=t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY-t.box.getY()):t.y-t.box.getY()>t.box.getHeight()+t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=-Math.abs(t.vy)*n),t.y=t.box.getHeight()+t.box.getY()-t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY)):"Rectangle"===M(t)&&(t.x-t.box.getX()<t.width/2*t.scalex+t.width/2*t.scalex*t.originX?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=Math.abs(t.vx)*n),t.x=t.width/2*t.scalex+t.width/2*t.scalex*t.originX+t.box.getX()):t.x-t.box.getX()>t.box.getWidth()-t.width/2*t.scalex+t.width/2*t.scalex*t.originX&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=-Math.abs(t.vx)*n),t.x=t.box.getWidth()-t.width/2*t.scalex+t.width/2*t.scalex*t.originX+t.box.getX()),t.y-t.box.getY()<t.height/2*t.scaley+t.height/2*t.scaley*t.originY?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=Math.abs(t.vy)*n),t.y=t.height/2*t.scaley+t.height/2*t.scaley*t.originY+t.box.getY()):t.y-t.box.getY()>t.box.getHeight()-t.height/2*t.scaley+t.height/2*t.scaley*t.originY&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=-Math.abs(t.vy)*n),t.y=t.box.getHeight()-t.height/2*t.scaley+t.height/2*t.scaley*t.originY+t.box.getY())):t.isMoving&&(t.isMoving=!1)})),o}return i(e,t),e.prototype.init=function(){},e.prototype.beforeRedraw=function(){},e.prototype.redraw=function(t){},e.prototype.afterRedraw=function(){},e.prototype.draw=function(t){},e.prototype.destroy=function(){this.manager.remove(this)},e.prototype.setBox=function(t){return this.box=t,this},e.prototype.setBodyBox=function(t){return t?this.bodyBox=t:this.initBodyBox(this.scene),this},e.prototype.getBodyBox=function(){return this.bodyBox},e.prototype.collide=function(t){var e,i,n,r;return"World"===M(t)||"BoundingBox"===M(t)?"Circle"===M(this)?this.collideCircWorld(this,null!==(i=null===(e=t)||void 0===e?void 0:e.bounds)&&void 0!==i?i:t):"Rectangle"===M(this)&&this.collideRectWorld(this,null!==(r=null===(n=t)||void 0===n?void 0:n.bounds)&&void 0!==r?r:t):"Circle"===M(this)&&"Circle"===M(t)?this.collideCirc(this,t):"Rectangle"===M(this)&&"Rectangle"===M(t)?this.collideRect(this,t):"Circle"===M(this)&&"Rectangle"===M(t)?this.collideCircRect(this,t):"Rectangle"===M(this)&&"Circle"===M(t)&&this.collideCircRect(t,this)},e.prototype.setScaleX=function(t){return this.scalex!==t&&(this.scalex=t),this},e.prototype.setScaleY=function(t){return this.scaley!==t&&(this.scaley=t),this},e.prototype.setScale=function(t,e){return this.setScaleX(t),this.setScaleY(null!=e?e:t),this},e.prototype.getScale=function(){return{x:this.scalex,y:this.scaley}},e.prototype.setOriginX=function(t){return this.originX!==t&&(this.originX=t),this},e.prototype.setOriginY=function(t){return this.originY!==t&&(this.originY=t),this},e.prototype.setOrigin=function(t,e){return this.setOriginX(t),this.setOriginY(null!=e?e:t),this},e.prototype.getOrigin=function(){return{x:this.originX,y:this.originY}},e.prototype.setVelocityX=function(t){return this.vx!==t&&(this.vx=t),this},e.prototype.setVelocityY=function(t){return this.vy!==t&&(this.vy=t),this},e.prototype.setVelocity=function(t,e){return this.setVelocityX(t),this.setVelocityY(e),this},e.prototype.getVelocity=function(){return{x:this.vx,y:this.vy}},e.prototype.getSpeed=function(){return this._speed},e.prototype.setSpeed=function(t){return this._speed!==t&&(this._speed=t),this},e.prototype.getGravity=function(){return this._gravity},e.prototype.setGravity=function(t){return this._gravity!==t&&(this._gravity=t),this},e.prototype.setManager=function(t){return this.manager=t,this},e.prototype.setBounceWithoutLosingSpeed=function(t){return this._bounceWithoutLosingSpeed=t,this},e.prototype.setName=function(t){return this.name=t,this},e.prototype.collideCirc=function(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<=Math.pow(t.radius*t.getScale().r+e.radius*e.getScale().r,2)},e.prototype.collideRect=function(t,e){var i=t.getBodyBox(),n=t.x+i.getX()+t.width/2*-t.getOrigin().x*t.getScale().x,r=t.y+i.getY()+t.height/2*-t.getOrigin().y*t.getScale().y;if(!e.getBodyBox)return!(n-i.getWidth()/2>e.width+e.x-e.width/2||e.x-e.width/2>i.getWidth()+n-i.getWidth()/2||r-i.getHeight()/2>e.height+e.y-e.height/2||e.y-e.height/2>i.getHeight()+r-i.getHeight()/2);var o=e.getBodyBox(),s=e.x+o.getX()+e.width/2*-e.getOrigin().x*e.getScale().x,a=e.y+o.getY()+e.height/2*-e.getOrigin().y*e.getScale().y;return!(n-i.getWidth()/2>o.getWidth()+s-o.getWidth()/2||s-o.getWidth()/2>i.getWidth()+n-i.getWidth()/2||r-i.getHeight()/2>o.getHeight()+a-o.getHeight()/2||a-o.getHeight()/2>i.getHeight()+r-i.getHeight()/2)},e.prototype.collideCircRect=function(t,e){var i=Math.abs(t.x-e.x-e.width/2),n=Math.abs(t.y-e.y-e.height/2);return!(i>e.width/2+t.radius*t.getScale().r||n>e.height/2+t.radius*t.getScale().r)&&(i<=e.width/2||n<=e.height/2||Math.pow(i-e.width/2,2)+Math.pow(n-e.height/2,2)<=t.radius*Math.pow(t.getScale().r,2))},e.prototype.collideCircWorld=function(t,e){var i=Math.abs(t.x-e.getX()),n=Math.abs(t.y-e.getY());return!(i>e.getWidth()+t.radius*t.getScale().r||n>e.getHeight()+t.radius*t.getScale().r)&&(i<=e.getWidth()||n<=e.getHeight()||Math.pow(i-e.getWidth(),2)+Math.pow(n-e.getHeight(),2)<=t.radius*Math.pow(t.getScale().r,2))},e.prototype.collideRectWorld=function(t,e){var i=t.getBodyBox();return!(t.x+i.getX()-i.getWidth()/2>e.getWidth()+e.getX()||e.getX()>i.getWidth()+(t.x+i.getX())||t.y+i.getY()-i.getHeight()/2>e.getHeight()+e.getY()||e.getY()>i.getHeight()+(t.y+i.getY()))},e.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&this[e]!==t[e]&&(this[e]=t[e])},e.prototype.toJSON=function(t){var e=this,i={};return t.forEach((function(t){i[t]=t in e?e[t]:null})),n({x:this.x,y:this.y,name:this.name},i)},e.prototype.initBodyBox=function(t){var e=0,i=0,n=null,r=null,o=this;this.setBodyBox(new k(t,{get:function(){return e},set:function(t){e=t}},{get:function(){return i},set:function(t){i=t}},{get:function(){return(n||o.width)*o.scalex},set:function(t){n=t}},{get:function(){return(r||o.height)*o.scaley},set:function(t){r=t}}))},e}(c),A=function(t){function e(e,i,n,r,o){var s=t.call(this,e,i,n)||this;return s.cropw=1,s.croph=1,s.width=r,s.height=o,s.fillColor="#fff",s}return i(e,t),Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),e.prototype.draw=function(t){t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),P(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),t.fillRect(this.x,this.y,this.width,this.height)),P(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.strokeRect(this.x,this.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},e.prototype.setCropW=function(t){return this.cropw!==t&&(this.cropw=t),this},e.prototype.setCropH=function(t){return this.croph!==t&&(this.croph=t),this},e.prototype.setCrop=function(t,e){return void 0===t&&(t=1),void 0===e&&(e=1),this.setCropW(t),this.setCropH(e),this},e.prototype.getCrop=function(){return{w:this.cropw,h:this.croph}},e}(C),E=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n)||this;return o.scaler=1,delete o.width,delete o.height,delete o.scalex,delete o.scaley,delete o.setScaleX,delete o.setScaleY,o.radius=r,o.angle=360,o.fillColor="#fff",o}return i(e,t),Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return"Circle"},enumerable:!1,configurable:!0}),e.prototype.setScaleR=function(t){return this.scaler=t,this},e.prototype.getScale=function(){return{r:this.scaler}},e.prototype.draw=function(t){var e=2*Math.PI*(this.angle/360);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.radius*-this.originX*this.scaler,this.radius*-this.originY*this.scaler),P(this.fillColor)&&(t.beginPath(),t.fillStyle=this.fillColor.toString(16),t.arc(this.x,this.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.fill(),t.closePath()),P(this.strokeColor)&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.arc(this.x,this.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.stroke(),t.closePath()),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},e}(C),T=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,null,null)||this;return o.use=r,o}return i(e,t),e.prototype.setSize=function(t){this.width=t.width,this.height=t.height},e.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),P(e)&&(P(this.width)||P(this.height)||this.setSize(e),t.drawImage(e,0,0,this.width*this.cropw,this.height*this.croph,this.x-this.scene.camera.x,this.y-this.scene.camera.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},e}(A),B=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.sprite={x:0,y:0,width:0,height:0},o}return i(e,t),e.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),P(e)&&(P(this.width)||P(this.height)||this.setSize(this.sprite),t.drawImage(e,this.sprite.x,this.sprite.y,this.sprite.width*this.cropw,this.sprite.height*this.croph,this.x,this.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},e.prototype.toJSON=function(e){return n(n({},t.prototype.toJSON.call(this,e)),{sprite:this.sprite})},e}(T),L=function(t){function e(e,i,n,r,o){var s=t.call(this,e,i,n,null,null)||this;return s.content=r,s.style=Object.assign({shadow:null,lineSpacing:6,background:null,align:"center",padding:null,font:null},o),s.style.shadow=Object.assign({offsetX:0,offsetY:0,color:"#000",blur:0},s.style.shadow),s.style.padding=Object.assign({left:0,right:0,top:0,bottom:0},s.style.padding),s.style.font=Object.assign({size:16,family:"Arial"},s.style.font),s}return i(e,t),e.prototype.draw=function(t){var e=this,i=0;if("right"===this.style.align&&(i=this.width/-2),"left"===this.style.align&&(i=this.width/2),t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.textBaseline="top",t.font=this.style.font.size+"px "+this.style.font.family,this.height=this.content.split("\n").reduce((function(i,n,r){return 0===r?(e.width=t.measureText(n.trim()).width,e.style.font.size):(e.width<t.measureText(n.trim()).width&&(e.width=t.measureText(n.trim()).width),i+e.style.lineSpacing+e.style.font.size)}),0),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),P(this.style.background))if(this.style.background instanceof C||this.manager.medias.images.get(this.style.background)instanceof C){var n="string"===M(this.style.background)?this.manager.medias.images.get(this.style.background):this.style.background;n.getScale().x===this.getScale().x&&n.getScale().y===this.getScale().y||n.setScale(this.getScale().x,this.getScale().y),n.getOrigin().x===this.getOrigin().x&&n.getOrigin().y===this.getOrigin().y||n.setOrigin(this.getOrigin().x,this.getOrigin().y),n.box!==this.box&&n.setBox(this.box),n.x!==this.x&&(n.x=this.x),n.y!==this.y&&(n.y=this.y)}else t.fillStyle=this.style.background.toString(16),t.fillRect(this.x,this.y,this.width+this.style.padding.left+this.style.padding.right,this.height+this.style.padding.top+this.style.padding.bottom);P(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),this.content.split("\n").forEach((function(n,r){t.fillText(n.trim(),e.x+e.style.padding.left+i,e.y+e.style.padding.top+(e.style.lineSpacing+e.style.font.size)*r)}),0)),P(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),this.content.split("\n").forEach((function(n,r){t.strokeText(n.trim(),e.x+e.style.padding.left+i,e.y+e.style.padding.top+(e.style.lineSpacing+e.style.font.size)*r)}),0)),t.shadowBlur=this.style.shadow.blur,t.shadowColor=this.style.shadow.color.toString(16),t.shadowOffsetX=this.style.shadow.offsetX,t.shadowOffsetY=this.style.shadow.offsetY,t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},e.prototype.getScale=function(){return{x:1,y:1}},e.prototype.setText=function(t){return this.content=t,this},e.prototype.toJSON=function(e){return n(n({},t.prototype.toJSON.call(this,e)),{content:this.content})},e}(A),X=function(t){function e(e){var i=t.call(this,e,0,0,0,0)||this;return i.setName("camera"),i.offAll("move:velocity"),i}return i(e,t),e.prototype.init=function(){this.center=new k(this.scene,"50%","50%",2,2),this.width=this.scene.game.canvas.width,this.height=this.scene.game.canvas.height},e.prototype.draw=function(){},e.prototype.setValues=function(t,e,i,n){return P(t)&&(this.x=t),P(e)&&(this.y=e),P(i)&&(this.width=i),P(n)&&(this.height=n),this},e.prototype.setTarget=function(t){return this.target="string"==typeof t?this.scene.entities.getEntity(t):t,this},e.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("targetName"===e?this.target=this.manager.getEntity(t[e]):"center"===e?(this.center||"BoundingBox"===M(this.center)||(this.center=new k(this.scene,t[e].x,t[e].y,t[e].width,t[e].height)),this.center.fromSave(t[e])):this[e]!==t[e]&&(this[e]=t[e]))},e.prototype.toJSON=function(){var t;return{x:this.x,y:this.y,name:this.name,width:this.width,height:this.height,targetName:null===(t=this.target)||void 0===t?void 0:t.name,center:this.center}},e}(A),Y=Object.freeze({__proto__:null,Rectangle:A,Circle:E,Image:T,Sprite:B,Text:L,Camera:X}),j=function(t){function e(e,i,n,r){void 0===r&&(r=!1);var o=t.call(this)||this;return o.scene=e,o.callback=i,o.unique=r,o.isPlaying=!1,o.wait=0,o.update=o.update.bind(o),o.scene.game.on("updated",o.update),o.setTimeWait(n),o}return i(e,t),e.prototype.getWaitValue=function(){return this.wait},e.prototype.setWaitValue=function(t){return this.wait=t,this},e.prototype.setTimeWait=function(t){return this.useTime="time"in t,this.useTick="tick"in t,this.time=t.time,this.tick=t.tick,this.setWaitValue(0)},e.prototype.update=function(){this.isPlaying&&(this.useTime?(this.setWaitValue(this.wait+1e3*this.scene.game.secondsPassed),this.time<=this.wait&&(this.callback(),this.unique?this.cancel():this.setWaitValue(0))):this.useTick&&(this.setWaitValue(this.wait+1),this.tick<=this.wait&&(this.callback(),this.unique?this.cancel():this.setWaitValue(0))))},e.prototype.cancel=function(){this.scene.game.off("updated",this.update),this.pause()},e.prototype.play=function(){this.isPlaying||(this.isPlaying=!0)},e.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1)},e}(c),R=new Map,H=function(t){function e(e){var i=t.call(this)||this;i.forcedLoadingOfEntities=[],i.managers=new O(i),i.entities=new V(i),i.world=new W(i),i.name=e.name,i.isPlayed="none",i.played=!1,i.alpha=1;var n=i;return i.create={box:function(t,e,i,r,o){void 0===o&&(o=[]);var s=new k(n.world,t,e,i,r);return o.forEach((function(t){return s.moveEntity(t)})),s},timer:function(t,e,i){return void 0===i&&(i=!1),new j(n,t,e,i)},entity:{rectangle:function(t,e,i,r,o,s){void 0===s&&(s=0);var a=new A(n,t,e,i,r);return a.zindex=s,a.fillColor=o,n.entities.add(a),a},circle:function(t,e,i,r,o){void 0===o&&(o=0);var s=new E(n,t,e,i);return s.zindex=o,s.fillColor=r,n.entities.add(s),s},image:function(t,e,i,r){void 0===r&&(r=0);var o=new T(n,t,e,i);return o.zindex=r,n.entities.add(o),o},sprite:function(t,e,i,r,o,s){void 0===s&&(s=0);var a=new B(n,t,e,i);return a.sprite.width=r,a.sprite.height=o,a.zindex=s,n.entities.add(a),a},text:function(t,e,i,r,o){void 0===r&&(r={}),void 0===o&&(o=0);var s=new L(n,t,e,i,r);return s.zindex=o,n.entities.add(s),s}}},i.camera=new X(i),i.entities.add(i.camera),i}return i(e,t),Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return"Scene"},enumerable:!1,configurable:!0}),e.prototype.init=function(){},e.prototype.beforeUpdate=function(){},e.prototype.update=function(t){},e.prototype.afterUpdate=function(){},e.prototype.changeAllow=function(t,e){return!0},e.prototype.getAudio=function(t){if(R.has(t)&&!R.get(t).isDeleted)return R.get(t);var e=this.entities.medias.audios.get(t);if(e){var i=new g(this.game,e,t);return R.set(t,i),i}return null},e.prototype.setName=function(t){return this.name=t,this},e.prototype.setGame=function(t){return this.game=t,this},e.prototype.setManager=function(t){return this.manager=t,this},e.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("entities"===e?this.entities.getAll().map((function(e){var i=t.entities.find((function(t){return t.name===e.name}));i&&e.fromSave(i)})):"camera"===e?this.camera.fromSave(t[e]):"world"===e?this.world.fromSave(t[e]):this[e]!==t[e]&&(this[e]=t[e]))},e.prototype.toJSON=function(t){return{name:this.name,world:this.world,camera:this.camera,alpha:this.alpha,entities:this.entities.getAll().filter((function(e){return"camera"!==e.name&&("object"!=typeof t||!t.exclude.entities.includes(e.name))})).map((function(e){return e.toJSON(t.entityProperties||[])}))}},e}(c),G=function(t){function e(e){var i=t.call(this)||this;i.x=0,i.y=0,i.width=1,i.height=1,i.click=!1,i.currentClickPos=new Map;var n=["left","center","right"];return i.game=e,e.canvas.addEventListener("mousedown",(function(t){i.click=!0,i.currentClickPos.set(n[t.button],t),i.globals.emit("mouse:down-"+n[t.button],t)})),e.canvas.addEventListener("mousemove",(function(t){i.x=t.offsetX,i.y=t.offsetY,i.globals.emit("mouse:move",t)})),e.canvas.addEventListener("mouseup",(function(t){i.click=!1,i.currentClickPos.delete(n[t.button]),i.globals.emit("mouse:up-"+n[t.button],t)})),e.canvas.addEventListener("touchstart",(function(t){var n=e.canvas.getBoundingClientRect();i.x=t.touches[0].clientX-n.left,i.y=t.touches[0].clientY-n.top,i.click=!0,i.currentClickPos.set("left",t),i.globals.emit("mouse:down-left",t)})),e.canvas.addEventListener("touchmove",(function(t){var n=e.canvas.getBoundingClientRect();i.x=t.touches[0].clientX-n.left,i.y=t.touches[0].clientY-n.top,i.globals.emit("mouse:move",t)})),e.canvas.addEventListener("touchend",(function(t){i.click=!1,i.currentClickPos.delete("left"),i.globals.emit("mouse:up-left",t)})),i}return i(e,t),Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),e.prototype.update=function(){var t=this;this.currentClickPos.forEach((function(e,i){t.globals.emit("mouse:down-"+i,e)}))},e.prototype.draw=function(t){t.setTransform(1,0,0,1,0,0),this.game.debug&&S(t,this)},e}(c),N={" ":["Space","Spacebar","Space Bar"],AltGraph:["Alt Gr"],ArrowDown:["Down"],ArrowLeft:["Left"],ArrowRight:["Right"],ArrowUp:["Up"],Backspace:["Backspace"],Control:["Ctrl","Ctl"],Delete:["Delete","Del"],Enter:["Enter","Return"],Escape:["Escape","Esc"],Insert:["Insert","Ins"],PageDown:["Page Down","PgDown"],PageUp:["Page Up","PgUp"],Tab:["Tab"]},z={arrows:["ArrowUp","ArrowLeft","ArrowDown","ArrowRight"],wasd:["W","A","S","D"],zqsd:["Z","Q","S","D"]},D=function(t){function e(){var e=t.call(this)||this;return e.pressed=new Set,e.globals.on("key:down",(function(t){var i=!1;for(var n in N)if(N[n].includes(t)){e.pressed.add(n.toLowerCase()),i=!0;break}i||e.pressed.add(t.toLowerCase())})),e.globals.on("key:up",(function(t){for(var i in N)if(N[i].includes(t)){e.pressed.delete(i.toLowerCase());break}e.pressed.delete(t.toLowerCase())})),e}return i(e,t),e.prototype.query=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return e.reduce((function(e,i){return e&&t.pressed.has(i.toLowerCase())}),!0)&&e.length>0},e.prototype.vectorQuery=function(t){if("string"==typeof t&&t.toLocaleLowerCase()in z){var e=new p(0,0);return this.query(z[t][0])&&(e.y-=1),this.query(z[t][1])&&(e.x-=1),this.query(z[t][2])&&(e.y+=1),this.query(z[t][3])&&(e.x+=1),e}if(t instanceof Array){e=new p(0,0);return this.query(t[0])&&(e.y-=1),this.query(t[1])&&(e.x-=1),this.query(t[2])&&(e.y+=1),this.query(t[3])&&(e.x+=1),e}return new p(0,0)},e}(c),I=function(t){function e(){var e=t.call(this)||this;return e.gamepads=[],e.globals.on("gamepad:add",(function(t){var i=new x;i.emit("add",t),e.gamepads=s(e.gamepads,[i])})),e.globals.on("gamepad:remove",(function(t){e.gamepads=e.gamepads.filter((function(e){return e.gamepad.id!==t.gamepad.id||(e.emit("remove",t),!1)}))})),e.pressed=new Set,e.withGamepad(0),e}return i(e,t),Object.defineProperty(e.prototype,"currentGamepad",{get:function(){return this.gamepads[this.gamepadIndex]},enumerable:!1,configurable:!0}),e.prototype.withGamepad=function(t){this.gamepadIndex=t},e.prototype.query=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return e.reduce((function(e,i){return!(t.gamepads.length<=t.gamepadIndex)&&(e&&t.currentGamepad.button(i).query())}),!0)&&e.length>0},e.prototype.vectorQuery=function(t){if("string"==typeof t&&this.gamepads.length>this.gamepadIndex){var e=this.currentGamepad.stick(t).query();return new p(Math.round(1e4*e.x)/1e4,Math.round(1e4*e.y)/1e4)}return new p(0,0)},e.prototype.vibrate=function(t,e){var i=void 0===e?{}:e,n=i.weakMagnitude,s=i.strongMagnitude;return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.currentGamepad.vibrate(t,{weakMagnitude:n,strongMagnitude:s})];case 1:return e.sent(),[2]}}))}))},e}(c),q=Object.freeze({__proto__:null,AudioLoader:_,Scene:H,Entity:C,World:W,BoundingBox:k,Mouse:G,Keyboard:D,Gamepad:I,Timer:j,ObjectEntities:Y}),V=function(t){function e(e){var i=t.call(this)||this;return i.scene=e,i.list=[],i}return i(e,t),Object.defineProperty(e.prototype,"medias",{get:function(){return e},enumerable:!1,configurable:!0}),e.addMedia=function(t,e){return e instanceof HTMLImageElement?this.images.set(t,e):e instanceof _?this.audios.set(t,e):e instanceof Text&&this.texts.set(t,e),this},e.prototype.add=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return this.list=s(this.list,e.map((function(e){return e instanceof Function?new e(t.scene,0,0).setManager(t):e.setManager(t)}))).sort((function(t,e){return t.zindex-e.zindex})),this},e.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=this.list.filter((function(e){return!t.includes(e)})),this},e.prototype.setEntities=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return this.list=e.map((function(e){return e instanceof C?e.setManager(t):new e(t.scene,0,0).setManager(t)})).sort((function(t,e){return e.zindex-t.zindex})),this},e.prototype.getEntity=function(t){var e=this.list.find((function(e){return e.name===t}));return e||(this.globals.emit("w"+m.Entity,"this entity "+t+" is not create"),new C(this.scene.game.currentScene,0,0))},e.prototype.getAll=function(){return this.list},e.images=new Map,e.audios=new Map,e.texts=new Map,e}(u),J=function(t){function e(e,i){var n=t.call(this)||this;return n.list=[],n.game=e,n.list=i.map((function(t){return t instanceof H?t.setGame(n.game).setManager(n):new t({name:t.name}).setGame(n.game).setManager(n)})),n}return i(e,t),e.create=function(t){return function(i){return new e(i,t)}},e.prototype.add=function(t){return this.list=s(t instanceof H?[t.setGame(this.game).setManager(this)]:[new t({name:t.name}).setGame(this.game).setManager(this)],this.list),this},e.prototype.getFirst=function(){return this.getScene(0)},e.prototype.getLast=function(){return this.getScene(this.list.length-1)},e.prototype.play=function(t){return this.game.playScene(this.getScene(t))},e.prototype.playWithOpacity=function(t,e){var i="object"==typeof t?t:this.getScene(t);return i.played=!0,i.isPlayed="opacity",i.alpha=w(e,1),this.game.playedWithOpacity.includes(i)||(this.game.playedWithOpacity=s(this.game.playedWithOpacity,[i])),i},e.prototype.getScene=function(t){if("string"==typeof t){if(e=this.list.find((function(e){return e.name===t})))return e;this.globals.emit("w"+m.Scene,"this scene "+t+" is not create")}else if("number"==typeof t){var e;if(e=this.list[t])return e;this.globals.emit("w"+m.Scene,"the "+t+(("1"===(n=(i=t).toString().split(""))[n.length-1]?i+"st":"2"===n[n.length-1]?i+"nd":"3"===n[n.length-1]?i+"rd":i+"th")+" scene has not been created"))}else if("object"==typeof t)return t;var i,n;return this.list[0]},e.prototype.getScenes=function(t){return void 0===t&&(t=function(t){return!0}),this.list.filter(t)},e}(u),U=Object.freeze({__proto__:null,AudioManager:g,ContainerManager:O,EntityManager:V,Manager:u,SceneManager:J}),F=function(){function t(t,e){this.isPlaying=!1,this.frame=-1,this.loop=this.loop.bind(this),this.callback=e,this.delay=1e3/t}return t.prototype.loop=function(t){P(this.time)||(this.time=t);var e=Math.floor((t-this.time)/this.delay);e>this.frame&&(this.frame=e,this.callback({time:t,frame:this.frame})),this.tref=requestAnimationFrame(this.loop)},t.prototype.frameRate=function(t){var e=1e3*this.delay;if(!arguments.length)return e;this.delay=1e3/t,this.frame=-1,this.time=null},t.prototype.start=function(){this.isPlaying||(this.isPlaying=!0,this.tref=requestAnimationFrame(this.loop))},t.prototype.pause=function(){this.isPlaying&&(cancelAnimationFrame(this.tref),this.isPlaying=!1,this.time=null,this.frame=-1)},t}(),K=function(t){function e(e,i,n,r,o){void 0===i&&(i=800),void 0===n&&(n=600),void 0===r&&(r=document),void 0===o&&(o=window);var s=t.call(this)||this;s.doc=r,s.win=o,s.secondsPassed=0,s.oldTimeStamp=0,s.inited=[],u.createType("Entity"),s.audioContext=new AudioContext,s.playedWithOpacity=[],s.debug=e.debug,s.pixel=e.pixel,s.update=s.update.bind(s),s.initScene=s.initScene.bind(s),s.canvas="object"==typeof e.canvas&&e.canvas instanceof HTMLCanvasElement?e.canvas:s.doc.body.appendChild(s.doc.createElement("canvas"));var a=s.canvas.parentNode;s.w=w(i,a.clientWidth),s.h=w(n,a.clientHeight),s.canvas.width=s.w,s.canvas.height=s.h;var h=s.w,c=s.h;"string"==typeof i&&i.trim().endsWith("%")&&"string"==typeof n&&n.trim().endsWith("%")&&s.globals.on("window:resize",(function(){"string"==typeof i&&i.trim().endsWith("%")&&h!==a.clientWidth&&(s.w=w(i,a.clientWidth),s.canvas.width=s.w),"string"==typeof n&&n.trim().endsWith("%")&&c!==a.clientHeight&&(s.h=w(n,a.clientHeight),s.canvas.height=s.h)})),e.pixel&&(s.canvas.style.imageRendering="Google Inc."===navigator.vendor?"pixelated":"crisp-edges"),s.context=s.canvas.getContext("2d"),s.sceneManager=e.scene(s);var l=Object.keys(e.load||{}),d=null;if("undefined"!==M(e.loadScene)){var g=e.loadScene.forcedLoadingOfEntities||[];l=l.filter((function(t){return!g.includes(t)})),g.forEach((function(t){e.load[t].then((function(e){return V.addMedia(t,e)})).catch((function(t){return s.globals.emit("e"+v.Load,t)}))})),d=s.sceneManager.add(e.loadScene).play(0),s.initScene(d),d.on("progress",(function(t){1===t&&d.emit("progress:ended")}))}for(var p=function(t){var i=l[t];e.load[i].then((function(e){V.addMedia(i,e),d&&d.emit("progress",(t+1)/l.length)})).catch((function(t){return s.globals.emit("e"+v.Load,t)}))},f=0;f<l.length;f++)p(f);return d||s.sceneManager.play(0),s.loop=new F(240,s.update),s.loop.start(),s.mouse=new G(s),s.keyboard=new D,s.gamepad=new I,s.eventsAndErrors(),s}return i(e,t),e.prototype.changeScene=function(t){var e=this.sceneManager.getScene(t);return(!P(this.currentScene)||this.currentScene.changeAllow(e,y.Next)||P(e)&&e.changeAllow(this.currentScene,y.Prev))&&(e.emit("called",this.currentScene),this.currentScene&&(this.currentScene.played=!1,this.currentScene.isPlayed="none"),e.played=!0,e.isPlayed="main",this.currentScene=e,this.playedWithOpacity=[]),this.currentScene},e.prototype.playScene=function(t){return this.changeScene(t)},e.prototype.getStateSave=function(t){var e=Object.assign({},{entityProperties:[],over:{},exclude:{}},t);return e.exclude=Object.assign({},{scenes:[],entities:[]},null==t?void 0:t.exclude),JSON.stringify({kle_id:navigator.platform+":"+navigator.productSub,over:e.over,scenes:{played:this.currentScene.toJSON(e),opacity:this.playedWithOpacity.filter((function(t){return!e.exclude.scenes.includes(t.name)})).map((function(t){return t.toJSON(e)})),not_played:this.sceneManager.getScenes((function(t){return!t.played&&!e.exclude.scenes.includes(t.name)})).map((function(t){return t.toJSON(e)}))}})},e.prototype.setStateSave=function(t,e){var i=this;void 0===e&&(e=!1);var n=JSON.parse(t);e&&n.kle_id===navigator.platform+":"+navigator.productSub&&this.globals.emit("e"+v.ClientKey,"the kle_id doesn't match with the client instance");var r=this.sceneManager.getScenes().find((function(t){return t.name===n.scenes.played.name}));r&&(this.playScene(r),r.fromSave(n.scenes.played),this.sceneManager.getScenes((function(t){return t!==r})).forEach((function(t){var e=n.scenes.opacity.find((function(e){return e.name===t.name}));if(e)return i.sceneManager.playWithOpacity(t,e.alpha),t.fromSave(e),null;var r=n.scenes.not_played.find((function(e){return e.name===t.name}));r&&t.fromSave(r)})))},e.prototype.initScene=function(t){if(!this.inited.includes(t.init)){this.inited=s(this.inited,[t.init]),t.init();for(var e=0,i=t.entities.getAll();e<i.length;e++){i[e].init()}for(var n=0,r=t.managers.getAllType("Entity");n<r.length;n++){r[n].init(t)}}if("main"===t.isPlayed)for(var o=0,a=this.playedWithOpacity;o<a.length;o++){var h=a[o];this.initScene(h)}},e.prototype.update=function(t){this.initScene(this.currentScene);var e=this.currentScene.entities.getAll();this.setFPS(t.time),this.mouse.update(),this.emit("updated"),this.globals.emit("window:resize"),this.currentScene.beforeUpdate();for(var i=0,n=e;i<n.length;i++){(v=n[i]).collide(this.mouse)&&v.emit("mouse:hover"),v.collide(this.mouse)&&this.mouse.click&&v.emit("mouse:click"),v.beforeRedraw(),v.redraw(this.secondsPassed),v.emit("move:velocity",v)}for(var r=0,o=this.playedWithOpacity;r<o.length;r++){var s=(f=o[r]).entities.getAll();f.beforeUpdate();for(var a=0,h=s;a<h.length;a++){(v=h[a]).collide(this.mouse)&&v.emit("mouse:hover"),v.collide(this.mouse)&&this.mouse.click&&v.emit("mouse:click"),v.beforeRedraw(),v.redraw(this.secondsPassed),v.emit("move:velocity",v)}}for(var c=0,u=this.currentScene.managers.getAllType("Entity");c<u.length;c++){u[c].update()}this.context.clearRect(0,0,this.w,this.h),this.context.save(),this.context.globalAlpha=1,this.context.fillStyle="#000",this.context.fillRect(0,0,this.w,this.h),this.context.restore(),this.pixel&&(this.context.imageSmoothingEnabled=!1,this.context.imageSmoothingQuality="high");for(var l=0,d=e;l<d.length;l++){(v=d[l]).hidden||v.draw(this.context),v.afterRedraw()}for(var g=0,p=this.playedWithOpacity;g<p.length;g++){for(var f,y=0,m=(f=p[g]).entities.getAll();y<m.length;y++){var v;(v=m[y]).hidden||v.draw(this.context),v.afterRedraw()}f.update(this.secondsPassed),f.afterUpdate()}this.context.globalAlpha=1,this.mouse.draw(this.context),this.currentScene.update(this.secondsPassed),this.currentScene.afterUpdate()},e.prototype.setFPS=function(t){this.secondsPassed=(t-this.oldTimeStamp)/1e3,this.oldTimeStamp=t,this.fps=Math.round(1/this.secondsPassed)},e.prototype.eventsAndErrors=function(){var t=new h;this.doc.addEventListener("visibilitychange",(function(){return t.emit("page:visibilitychange")})),this.win.addEventListener("keydown",(function(e){t.emit("key:down",e.key)})),this.win.addEventListener("keyup",(function(e){t.emit("key:up",e.key)})),this.win.addEventListener("gamepadconnected",(function(e){t.emit("gamepad:add",e)})),this.win.addEventListener("gamepaddisconnected",(function(e){t.emit("gamepad:remove",e)}));var e=function(e){/\d/.test(e)&&t.on("e"+e,(function(t){return console.error("["+v[e]+"]: "+t)}))};for(var i in v)e(i);var n=function(e){/\d/.test(e)&&t.on("w"+e,(function(t){return console.warn("["+m[e]+"]: "+t)}))};for(var i in m)n(i)},e}(c);var Q=Object.freeze({__proto__:null,Image:function(t){return new Promise((function(e,i){var n=document.createElement("img");n.src=t,n.onload=function(){return e(n)},n.onerror=i}))},Audio:function(t){return new Promise((function(e,i){var n=new _(t);n.on("loadeddata",(function(){return e(n)})),n.on("error",i)}))},Text:function(t){return new Promise((function(e,i){e(document.createTextNode(t))}))},DOM:function(t){return new Promise((function(e,i){t instanceof HTMLImageElement&&!t.complete||t instanceof HTMLMediaElement&&t.readyState<2?(t.onloadeddata=function(){return e(t)},t.onerror=i):e(t)}))}});t.EventEmitter=c,t.Game=K,t.Loaders=Q,t.Managers=U,t.Objects=q,Object.defineProperty(t,"__esModule",{value:!0})}));
