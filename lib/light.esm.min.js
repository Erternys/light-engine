/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};function e(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}function i(t,e,i,n){return new(i||(i=Promise))((function(s,r){function o(t){try{h(n.next(t))}catch(t){r(t)}}function a(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((n=n.apply(t,e||[])).next())}))}function n(t,e){var i,n,s,r,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,n&&(s=2&r[0]?n.return:r[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,r[1])).done)return s;switch(n=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return o.label++,{value:r[1],done:!1};case 5:o.label++,n=r[1],r=[0];continue;case 7:r=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==r[0]&&2!==r[0])){o=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){o.label=r[1];break}if(6===r[0]&&o.label<s[1]){o.label=s[1],s=r;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(r);break}s[2]&&o.ops.pop(),o.trys.pop();continue}r=e.call(t,o)}catch(t){r=[6,t],n=0}finally{i=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function s(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),s=0;for(e=0;e<i;e++)for(var r=arguments[e],o=0,a=r.length;o<a;o++,s++)n[s]=r[o];return n}var r=new Map,o=function(){function t(){this.events=r}return t.prototype.has=function(t){return this.events.has(t)},t.prototype.get=function(t){return this.events.get(t)},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return!!this.has(t)&&(this.events.set(t,this.get(t).map((function(t){return t instanceof Array?t[1]?t:(t[0].apply(t,e),[t[0],!0]):(t.apply(void 0,e),t)}))),!0)},t.prototype.on=function(t,e){return this.events.set(t,s(this.get(t)||[],[e])),this},t.prototype.once=function(t,e){return this.events.set(t,s(this.get(t)||[],[[e,!1]])),this},t.prototype.off=function(t,e){if(!this.has(t))return!1;var i=this.get(t);return!!i&&(this.events.set(t,i.filter((function(t){return t!==e}))),0!==i.length||this.events.delete(t))},t.prototype.offAll=function(t){return this.has(t)?this.events.delete(t):(this.events.clear(),!0)},t}(),a=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.events=new Map,e}return e(i,t),Object.defineProperty(i.prototype,"globals",{get:function(){return new o},enumerable:!1,configurable:!0}),i}(o),h=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},c=[["A"],["B"],["X"],["Y"],["Left Bumper","LB"],["Right Bumper","RB"],["Left Trigger","LT"],["Right Trigger","RT"],["Back","View"],["Start"],["Left Stick"],["Right Stick"],["Up","DpadUp"],["Down","DpadDown"],["Left","DpadLeft"],["Right","DpadRight"],["Home","Guide","Xbox"]];var u,l,d,p={left:{label:"Left stick",xAxis:0,yAxis:1},right:{label:"Right stick",xAxis:2,yAxis:3}},g=function(t){function s(e){void 0===e&&(e=navigator);var i=t.call(this)||this;return i.gamepadTimestamp=0,i.navigator=e,i.cgamepad=null,i.store={preferGamepad:!1},i.on("add",(function(t){var e=t.gamepad;if(i.isConnected())return null;"standard"===e.mapping&&(i.cgamepad=e,i.gamepadIndex=e.index,i.store.preferGamepad=!0)})),i.on("remove",(function(t){var e=t.gamepad;if(i.gamepadIndex!==e.index)return null;i.gamepadIndex=void 0,i.store.preferGamepad=!1,i.offAll()})),i}return e(s,t),s.prototype.isConnected=function(){return void 0!==this.gamepadIndex&&this.gamepad.connected},Object.defineProperty(s.prototype,"gamepad",{get:function(){var t=this.navigator.getGamepads()[this.gamepadIndex];return t?(t.timestamp>this.gamepadTimestamp&&(this.store.preferGamepad=!0,this.gamepadTimestamp=t.timestamp),t):this.cgamepad},enumerable:!1,configurable:!0}),s.prototype.button=function(t){var e=this,i=function(t){if("number"==typeof t)return t;for(var e=0,i=0,n=c;i<n.length;i++){for(var s=0,r=n[i];s<r.length;s++){var o=r[s];if(t.toLowerCase()===o.toLowerCase())return e}e++}throw new Error('There is no gamepad button called "'+t+'"!')}(t);return{label:c[i][0],query:function(){return!!e.isConnected()&&e.gamepad.buttons[i].pressed}}},s.prototype.stick=function(t){var e,i=this;if("string"==typeof t){if(!(t in p))throw new Error('Gamepad stick "'+t+'" not found!');e=p[t]}else e=t;return{label:e.label,query:function(){return i.isConnected()?new h(i.gamepad.axes[e.xAxis],i.gamepad.axes[e.yAxis]):new h(0,0)}}},s.prototype.vibrate=function(t,e){var s=void 0===e?{}:e,r=s.weakMagnitude,o=s.strongMagnitude;return i(this,void 0,Promise,(function(){var e;return n(this,(function(i){switch(i.label){case 0:return this.isConnected()&&((e=this.gamepad.vibrationActuator)&&"dual-rumble"===e.type)?[4,e.playEffect("dual-rumble",{duration:t,strongMagnitude:o,weakMagnitude:r})]:[2];case 1:return i.sent(),[2]}}))}))},s}(a),f=new Map;function y(t,e){return"number"==typeof t?t:t.trim().endsWith("px")?Number(t.replace(/px$/,"")):t.trim().endsWith("%")?e*(Number(t.replace(/%$/,""))/100):0}function m(t,e,i){t.beginPath(),t.fillStyle="#f00",t.arc(e,i,3,0,2*Math.PI),t.fill()}function v(t){return null!=t}function b(t){if("object"==typeof t||void 0===t){if(null==t)return"undefined";if(t===Promise.prototype)return"Promise";if(void 0!==t[Symbol.toStringTag])return t[Symbol.toStringTag];var e=Object.prototype.toString.call(t).replace(/\[object (.*)\]/,(function(t,e){return e}));return"global"===e||"Window"===e||"DedicatedWorkerGlobalScope"===e||"WorkerGlobalScope"===e?"global":e}return typeof t}!function(t){t[t.Next=0]="Next",t[t.Prev=1]="Prev"}(u||(u={})),function(t){t[t.Scene=0]="Scene",t[t.Entity=1]="Entity"}(l||(l={})),function(t){t[t.Load=0]="Load",t[t.Audio=1]="Audio"}(d||(d={}));var w=function(t){function s(e,i){var n=t.call(this)||this;return n.isPlaying=!1,n.isPaused=!0,n.state={},n.changePageVisible=n.changePageVisible.bind(n),n.key=i,n.audio=e,n.context=new AudioContext,n.gain=n.context.createGain(),n.gain.connect(n.context.destination),n.source=n.context.createBufferSource(),n.getAudio(n.audio.src).then((function(t){n.state.started=!1,n.source.buffer=t,n.source.loop=!0,n.source.connect(n.gain),n.volume=1,n.speed=1})).catch((function(t){return n.globals.emit("error",t)})),n.globals.on("page:visibilitychange",n.changePageVisible),n}return e(s,t),Object.defineProperty(s.prototype,"volume",{get:function(){return this.state.volume},set:function(t){this.state.volume=t,this.gain.gain.value=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"speed",{get:function(){return this.state.speed},set:function(t){this.state.speed=t,this.source.playbackRate.value=t},enumerable:!1,configurable:!0}),s.prototype.play=function(){this.isPaused&&(this.state.started?this.context.resume():(this.source.start(),this.state.started=!0),this.isPlaying=!0,this.isPaused=!1)},s.prototype.pause=function(){this.isPlaying&&(this.context.suspend(),this.isPaused=!0,this.isPlaying=!1)},s.prototype.toggle=function(){this.isPlaying?this.pause():this.play()},s.prototype.destroy=function(){this.gain.disconnect(),this.source.stop(),this.source.disconnect(),this.context.close(),this.globals.off("page:visibilitychange",this.changePageVisible)},s.prototype.getAudio=function(t){return i(this,void 0,Promise,(function(){var e,i;return n(this,(function(n){switch(n.label){case 0:return f.has(t)?[2,f.get(t)]:[4,fetch(t)];case 1:return[4,n.sent().arrayBuffer()];case 2:return e=n.sent(),[4,this.context.decodeAudioData(e)];case 3:return i=n.sent(),f.set(t,i),[2,i]}}))}))},s.prototype.changePageVisible=function(){document.hidden&&this.isPlaying?this.context.suspend():!document.hidden&&this.isPlaying&&this.context.resume()},s}(a),x=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.clones=[],e}return e(i,t),i.prototype.createClone=function(){var t=new w(this.audio,this.key);return this.clones.push(t),t},i.prototype.deletion=function(){this.destroy(),this.clones.forEach((function(t){return t.destroy()}))},i}(w),S=function(){function t(t,e,i,n,s){this.rebound=!1,"Scene"===b(t)?this.parent=t.world:this.parent=t,this._x=e,this._y=i,this._width=n,this._height=s}return Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return"BoundingBox"},enumerable:!1,configurable:!0}),t.prototype.clone=function(){return new t(this.parent,this._x,this._y,this._width,this._height)},t.prototype.getX=function(){if("number"==typeof this._x)return this._x;if("string"==typeof this._x)return y(this._x,this.parent?this.parent.bounds.getWidth():0);var t=this._x.get();return"number"==typeof t?t:"string"==typeof t?y(t,this.parent?this.parent.bounds.getWidth():0):0},t.prototype.setX=function(t){"object"==typeof this._x?this._x.set(t):this._x=t},t.prototype.getY=function(){if("number"==typeof this._y)return this._y;if("string"==typeof this._y)return y(this._y,this.parent?this.parent.bounds.getHeight():0);var t=this._y.get();return"number"==typeof t?t:"string"==typeof t?y(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setY=function(t){"object"==typeof this._y?this._y.set(t):this._y=t},t.prototype.getWidth=function(){if("number"==typeof this._width)return this._width;if("string"==typeof this._width)return y(this._width,this.parent?this.parent.bounds.getWidth():0);var t=this._width.get();return"number"==typeof t?t:"string"==typeof t?y(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setWidth=function(t){"object"==typeof this._width?this._width.set(t):this._width=t},t.prototype.getHeight=function(){if("number"==typeof this._height)return this._height;if("string"==typeof this._height)return y(this._height,this.parent?this.parent.bounds.getHeight():0);var t=this._height.get();return"number"==typeof t?t:"string"==typeof t?y(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setHeight=function(t){"object"==typeof this._height?this._height.set(t):this._height=t},t.prototype.moveEntity=function(t){return t.setBox(this),this},t}(),M=function(t){function i(e){var i=t.call(this)||this,n=null,s=null,r=null,o=null;return i.isActive=!1,i.bounds=new S(i,{get:function(){return n||e.camera.x},set:function(t){n=t}},{get:function(){return s||e.camera.y},set:function(t){s=t}},{get:function(){return r||e.camera.width},set:function(t){r=t}},{get:function(){return o||e.camera.height},set:function(t){o=t}}),i}return e(i,t),Object.defineProperty(i.prototype,Symbol.toStringTag,{get:function(){return"World"},enumerable:!1,configurable:!0}),i.prototype.activation=function(t){this.isActive=t},i}(a),P=function(t){function i(e,i,n){var s,r=t.call(this)||this;r.hidden=!1,r.name="",r.lineWidth=1,r.originX=0,r.originY=0,r.alpha=1,r.zindex=0,r.scalex=1,r.scaley=1,r.vx=0,r.vy=0,r._speed=1,r._gravity=0,r._bounceWithoutLosingSpeed=!0,r.scene=e,r.box=null===(s=null==e?void 0:e.world)||void 0===s?void 0:s.bounds,r.x=i,r.y=n;return r.on("move:velocity",(function(){var t,e;r.isMoving||(r.isMoving=!0),r.x+=r.vx*r._speed*r.scene.game.secondsPassed,r.y+=r.vy*(r._gravity||r._speed)*r.scene.game.secondsPassed,(null===(e=null===(t=r.box)||void 0===t?void 0:t.parent)||void 0===e?void 0:e.isActive)?"Circle"===b(r)?(r.x<r.radius?(r.isMoving&&(r.isMoving=!1),r.vx=.9*Math.abs(r.vx),r.x=r.radius):r.x>r.box.getWidth()-r.radius&&(r.isMoving&&(r.isMoving=!1),r.vx=.9*-Math.abs(r.vx),r.x=r.box.getWidth()-r.radius),r.y<r.radius?(r.isMoving&&(r.isMoving=!1),r.vy=.9*Math.abs(r.vy),r.y=r.radius):r.y>r.box.getHeight()-r.radius&&(r.isMoving&&(r.isMoving=!1),r.vy=.9*-Math.abs(r.vy),r.y=r.box.getHeight()-r.radius)):"Rectangle"===b(r)&&(r.x<r.width/2?(r.isMoving&&(r.isMoving=!1),r.box.rebound&&(r.vx=Math.abs(r.vx)*(.9+(r._bounceWithoutLosingSpeed?.1:0))),r.x=r.width/2):r.x>r.box.getWidth()-r.width/2&&(r.isMoving&&(r.isMoving=!1),r.box.rebound&&(r.vx=-Math.abs(r.vx)*(.9+(r._bounceWithoutLosingSpeed?.1:0))),r.x=r.box.getWidth()-r.width/2),r.y<r.height/2?(r.isMoving&&(r.isMoving=!1),r.box.rebound&&(r.vy=Math.abs(r.vy)*(.9+(r._bounceWithoutLosingSpeed?.1:0))),r.y=r.height/2):r.y>r.box.getHeight()-r.height/2&&(r.isMoving&&(r.isMoving=!1),r.box.rebound&&(r.vy=-Math.abs(r.vy)*(.9+(r._bounceWithoutLosingSpeed?.1:0))),r.y=r.box.getHeight()-r.height/2)):r.isMoving&&(r.isMoving=!1)})),r}return e(i,t),i.prototype.init=function(){},i.prototype.beforeRedraw=function(){},i.prototype.redraw=function(t){},i.prototype.afterRedraw=function(){},i.prototype.draw=function(t){},i.prototype.setBox=function(t){return this.box=t,this},i.prototype.collide=function(t){var e,i,n,s;return"World"===b(t)||"BoundingBox"===b(t)?"Circle"===b(this)?this.collideCircWorld(this,null!==(i=null===(e=t)||void 0===e?void 0:e.bounds)&&void 0!==i?i:t):"Rectangle"===b(this)&&this.collideRectWorld(this,null!==(s=null===(n=t)||void 0===n?void 0:n.bounds)&&void 0!==s?s:t):"Circle"===b(this)&&"Circle"===b(t)?this.collideCirc(this,t):"Rectangle"===b(this)&&"Rectangle"===b(t)?this.collideRect(this,t):"Circle"===b(this)&&"Rectangle"===b(t)?this.collideCircRect(this,t):"Rectangle"===b(this)&&"Circle"===b(t)&&this.collideCircRect(t,this)},i.prototype.setScaleX=function(t){return this.scalex!==t&&(this.scalex=t),this},i.prototype.setScaleY=function(t){return this.scaley!==t&&(this.scaley=t),this},i.prototype.setScale=function(t,e){return this.setScaleX(t),this.setScaleY(null!=e?e:t),this},i.prototype.getScale=function(){return{x:this.scalex,y:this.scaley}},i.prototype.setVelocityX=function(t){return this.vx!==t&&(this.vx=t),this},i.prototype.setVelocityY=function(t){return this.vy!==t&&(this.vy=t),this},i.prototype.setVelocity=function(t,e){return this.setVelocityX(t),this.setVelocityY(e),this},i.prototype.getVelocity=function(){return{x:this.vx,y:this.vy}},i.prototype.getSpeed=function(){return this._speed},i.prototype.setSpeed=function(t){return this._speed!==t&&(this._speed=t),this},i.prototype.getGravity=function(){return this._gravity},i.prototype.setGravity=function(t){return this._gravity!==t&&(this._gravity=t),this},i.prototype.setManager=function(t){return this.manager=t,this},i.prototype.setBounceWithoutLosingSpeed=function(t){return this._bounceWithoutLosingSpeed=t,this},i.prototype.collideCirc=function(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<=Math.pow(t.radius+e.radius,2)},i.prototype.collideRect=function(t,e){return!(t.x-t.width/2>e.width+e.x-e.width/2||e.x-e.width/2>t.width+t.x-t.width/2||t.y-t.height/2>e.height+e.y-e.height/2||e.y-e.height/2>t.height+t.y-t.height/2)},i.prototype.collideCircRect=function(t,e){var i=Math.abs(t.x-e.x-e.width/2),n=Math.abs(t.y-e.y-e.height/2);return!(i>e.width/2+t.radius||n>e.height/2+t.radius)&&(i<=e.width/2||n<=e.height/2||Math.pow(i-e.width/2,2)+Math.pow(n-e.height/2,2)<=Math.pow(t.radius,2))},i.prototype.collideCircWorld=function(t,e){var i=Math.abs(t.x-e.getX()),n=Math.abs(t.y-e.getY());return!(i>e.getWidth()+t.radius||n>e.getHeight()+t.radius)&&(i<=e.getWidth()||n<=e.getHeight()||Math.pow(i-e.getWidth(),2)+Math.pow(n-e.getHeight(),2)<=Math.pow(t.radius,2))},i.prototype.collideRectWorld=function(t,e){return!(t.x-t.width/2>e.getWidth()+e.getX()||e.getX()>t.width+t.x||t.y-t.height/2>e.getHeight()+e.getY()||e.getY()>t.height+t.y)},i}(a),_=function(t){function i(e,i,n,s,r){var o=t.call(this,e,i,n)||this;return o.width=s,o.height=r,o.fillColor="#fff",o}return e(i,t),Object.defineProperty(i.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),i.prototype.draw=function(t){t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width*this.originX*this.scalex,this.height*this.originY*this.scaley),v(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),t.fillRect(this.x,this.y,this.width,this.height)),v(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.strokeRect(this.x,this.y,this.width*this.scalex,this.height*this.scaley)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&m(t,this.x,this.y)},i}(P),k=function(t){function i(e,i,n,s){var r=t.call(this,e,i,n)||this;return r.scaler=1,delete r.width,delete r.height,delete r.scalex,delete r.scaley,delete r.setScaleX,delete r.setScaleY,r.radius=s,r.angle=360,r.fillColor="#fff",r}return e(i,t),Object.defineProperty(i.prototype,Symbol.toStringTag,{get:function(){return"Circle"},enumerable:!1,configurable:!0}),i.prototype.setScaleR=function(t){return this.scaler=t,this},i.prototype.getScale=function(){return{r:this.scaler}},i.prototype.draw=function(t){var e=2*Math.PI*(this.angle/360);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),t.translate(this.radius*this.originX*this.scaler,this.radius*this.originY*this.scaler),v(this.fillColor)&&(t.beginPath(),t.fillStyle=this.fillColor.toString(16),t.arc(this.x-this.scene.camera.x,this.y-this.scene.camera.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.fill()),v(this.strokeColor)&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.arc(this.x-this.scene.camera.x,this.y-this.scene.camera.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.stroke()),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&m(t,this.x-this.scene.camera.x,this.y-this.scene.camera.y)},i}(P),C=function(t){function i(e,i,n,s){var r=t.call(this,e,i,n,null,null)||this;return r.use=s,r}return e(i,t),i.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width*this.originX*this.scalex,this.height*this.originY*this.scaley),v(e)&&(v(this.width)||v(this.height)||(this.width=e.width,this.height=e.height),t.drawImage(e,this.x-this.scene.camera.x,this.y-this.scene.camera.y,this.width*this.scalex,this.height*this.scaley)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&m(t,this.x-this.scene.camera.x,this.y-this.scene.camera.y)},i}(_),A=function(t){function i(e,i,n,s){var r=t.call(this,e,i,n,s)||this;return r.sprite={x:0,y:0,width:0,height:0},r}return e(i,t),i.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width*this.originX*this.scalex,this.height*this.originY*this.scaley),v(e)&&(v(this.width)||v(this.height)||(this.width=this.sprite.width,this.height=this.sprite.height),t.drawImage(e,this.sprite.x,this.sprite.y,this.sprite.width,this.sprite.height,this.x,this.y,this.width*this.scalex,this.height*this.scaley)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&m(t,this.x,this.y)},i}(C),W=function(t){function i(e,i,n,s,r){var o=t.call(this,e,i,n,null,null)||this;return o.content=s,o.style=Object.assign({shadow:null,lineSpacing:6,background:null,align:"center",padding:null,font:null},r),o.style.shadow=Object.assign({offsetX:0,offsetY:0,color:"#000",blur:0},o.style.shadow),o.style.padding=Object.assign({left:0,right:0,top:0,bottom:0},o.style.padding),o.style.font=Object.assign({size:16,family:"Arial"},o.style.font),o}return e(i,t),i.prototype.draw=function(t){var e=0;"right"===this.style.align&&(e=this.width/-2),"left"===this.style.align&&(e=this.width/2),t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width*this.originX*this.scalex,this.height*this.originY*this.scaley),t.textBaseline="top",t.font=this.style.font.size+"px "+this.style.font.family,this.content!==this.lastContent&&(this.lastContent=this.content,this.width=t.measureText(this.content).width,this.height=this.style.font.size),v(this.style.background)&&(t.fillStyle=this.style.background.toString(16),t.fillRect(this.x,this.y,this.width+this.style.padding.left+this.style.padding.right,this.height+this.style.padding.top+this.style.padding.bottom)),v(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),t.fillText(this.content,this.x+this.style.padding.left+e,this.y+this.style.padding.top)),v(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.strokeText(this.content,this.x+this.style.padding.left+e,this.y+this.style.padding.top)),t.shadowBlur=this.style.shadow.blur,t.shadowColor=this.style.shadow.color.toString(16),t.shadowOffsetX=this.style.shadow.offsetX,t.shadowOffsetY=this.style.shadow.offsetY,t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&m(t,this.x,this.y)},i}(_),L=function(t){function i(e){var i=t.call(this,e,0,0,0,0)||this;return i.name="camera",i.offAll("move:velocity"),i}return e(i,t),i.prototype.init=function(){this.center=new S(this.scene,"50%","50%",2,2),this.width=this.scene.game.canvas.width,this.height=this.scene.game.canvas.height},i.prototype.draw=function(){},i.prototype.redraw=function(){this.target&&this.target.collide(this.center)&&(this.x+this.scene.game.canvas.width<this.width&&(this.x+=this.target.getVelocity().x*this.target.getSpeed()*this.scene.game.secondsPassed),this.y+this.scene.game.canvas.height<this.height&&(this.y+=this.target.getVelocity().y*(this.target.getGravity()||this.target.getSpeed())*this.scene.game.secondsPassed))},i.prototype.setValues=function(t,e,i,n){return v(t)&&(this.x=t),v(e)&&(this.y=e),v(i)&&(this.width=i),v(n)&&(this.height=n),this},i.prototype.setTarget=function(t){return this.target="string"==typeof t?this.scene.entities.getEntity(t):t,this},i}(_),E=Object.freeze({__proto__:null,Rectangle:_,Circle:k,Image:C,Sprite:A,Text:W,Camera:L}),R=function(t){function i(e){var i=t.call(this)||this;i.forcedLoadingOfEntities=[],i.entities=new X(i),i.world=new M(i),i.name=e.name,i.isPlayed="none",i.played=!1,i.alpha=1;var n=i;return i.create={box:function(t,e,i,s,r){void 0===r&&(r=[]);var o=new S(n.world,t,e,i,s);return r.forEach((function(t){return o.moveEntity(t)})),o},entity:{rectangle:function(t,e,i,s,r,o){void 0===o&&(o=0);var a=new _(n,t,e,i,s);return a.zindex=o,a.fillColor=r,n.entities.add(a),a},circle:function(t,e,i,s,r){void 0===r&&(r=0);var o=new k(n,t,e,i);return o.zindex=r,o.fillColor=s,n.entities.add(o),o},image:function(t,e,i,s){void 0===s&&(s=0);var r=new C(n,t,e,i);return r.zindex=s,n.entities.add(r),r},sprite:function(t,e,i,s,r,o){void 0===o&&(o=0);var a=new A(n,t,e,i);return a.sprite.width=s,a.sprite.height=r,a.zindex=o,n.entities.add(a),a},text:function(t,e,i,s,r){void 0===s&&(s={}),void 0===r&&(r=0);var o=new W(n,t,e,i,s);return o.zindex=r,n.entities.add(o),o}}},i.camera=new L(i),i.entities.add(i.camera),i}return e(i,t),Object.defineProperty(i.prototype,Symbol.toStringTag,{get:function(){return"Scene"},enumerable:!1,configurable:!0}),i.prototype.init=function(){},i.prototype.beforeUpdate=function(){},i.prototype.update=function(t){},i.prototype.afterUpdate=function(){},i.prototype.changeAllow=function(t,e){return!0},i.prototype.getAudio=function(t){var e=this.entities.medias.audios.get(t);if(e)return new x(e,t)},i.prototype.setName=function(t){return this.name=t,this},i.prototype.setGame=function(t){return this.game=t,this},i.prototype.setManager=function(t){return this.manager=t,this},i}(a),O=function(t){function i(e){var i=t.call(this)||this;i.x=0,i.y=0,i.width=1,i.height=1,i.click=!1,i.currentClickPos=new Map;var n=["left","center","right"];return i.game=e,e.canvas.addEventListener("mousemove",(function(t){i.x=t.offsetX,i.y=t.offsetY,i.globals.emit("mouse:move",t)})),e.canvas.addEventListener("mousedown",(function(t){i.click=!0,i.currentClickPos.set(n[t.which],t),i.globals.emit("mouse:down-"+n[t.which],t)})),e.canvas.addEventListener("mouseup",(function(t){i.click=!1,i.currentClickPos.delete(n[t.which]),i.globals.emit("mouse:up-"+n[t.which],t),i.globals.emit("mouse:up-"+n[t.which],t)})),i}return e(i,t),Object.defineProperty(i.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),i.prototype.update=function(){var t=this;this.currentClickPos.forEach((function(e,i){t.globals.emit("mouse:down-"+i,e)}))},i.prototype.draw=function(t){t.setTransform(1,0,0,1,0,0),this.game.debug&&m(t,this.x,this.y)},i}(a),T={" ":["Space","Spacebar","Space Bar"],AltGraph:["Alt Gr"],ArrowDown:["Down"],ArrowLeft:["Left"],ArrowRight:["Right"],ArrowUp:["Up"],Backspace:["Backspace"],Control:["Ctrl","Ctl"],Delete:["Delete","Del"],Enter:["Enter","Return"],Escape:["Escape","Esc"],Insert:["Insert","Ins"],PageDown:["Page Down","PgDown"],PageUp:["Page Up","PgUp"],Tab:["Tab"]},j={arrows:["ArrowUp","ArrowLeft","ArrowDown","ArrowRight"],wasd:["W","A","S","D"],zqsd:["Z","Q","S","D"]},G=function(t){function i(){var e=t.call(this)||this;return e.pressed=new Set,e.globals.on("key:down",(function(t){var i=!1;for(var n in T)if(T[n].includes(t)){e.pressed.add(n.toLowerCase()),i=!0;break}i||e.pressed.add(t.toLowerCase())})),e.globals.on("key:up",(function(t){for(var i in T)if(T[i].includes(t)){e.pressed.delete(i.toLowerCase());break}e.pressed.delete(t.toLowerCase())})),e}return e(i,t),i.prototype.query=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return e.reduce((function(e,i){return e&&t.pressed.has(i.toLowerCase())}),!0)&&e.length>0},i.prototype.vectorQuery=function(t){if("string"==typeof t&&t in j){var e=new h(0,0);return this.query(j[t][0])&&(e.y-=1),this.query(j[t][1])&&(e.x-=1),this.query(j[t][2])&&(e.y+=1),this.query(j[t][3])&&(e.x+=1),e}if(t instanceof Array){e=new h(0,0);return this.query(t[0])&&e.y,this.query(t[1])&&(e.x-=1),this.query(t[2])&&(e.y+=1),this.query(t[3])&&(e.x+=1),e}return new h(0,0)},i}(a),H=function(t){function r(){var e=t.call(this)||this;return e.gamepads=[],e.globals.on("gamepad:add",(function(t){var i=new g;i.emit("add",t),e.gamepads=s(e.gamepads,[i])})),e.globals.on("gamepad:remove",(function(t){e.gamepads=e.gamepads.filter((function(e){return e.gamepad.id!==t.gamepad.id||(e.emit("remove",t),!1)})),console.log(e.gamepads)})),e.pressed=new Set,e.withGamepad(0),e}return e(r,t),Object.defineProperty(r.prototype,"currentGamepad",{get:function(){return this.gamepads[this.gamepadIndex]},enumerable:!1,configurable:!0}),r.prototype.withGamepad=function(t){this.gamepadIndex=t},r.prototype.query=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return e.reduce((function(e,i){return!(t.gamepads.length<=t.gamepadIndex)&&(e&&t.currentGamepad.button(i).query())}),!0)&&e.length>0},r.prototype.vectorQuery=function(t){if("string"==typeof t&&this.gamepads.length>this.gamepadIndex){var e=this.currentGamepad.stick(t).query();return new h(Math.round(1e4*e.x)/1e4,Math.round(1e4*e.y)/1e4)}return new h(0,0)},r.prototype.vibrate=function(t,e){var s=void 0===e?{}:e,r=s.weakMagnitude,o=s.strongMagnitude;return i(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,this.currentGamepad.vibrate(t,{weakMagnitude:r,strongMagnitude:o})];case 1:return e.sent(),[2]}}))}))},r}(a),B=Object.freeze({__proto__:null,Scene:R,Entity:P,World:M,BoundingBox:S,Mouse:O,Keyboard:G,Gamepad:H,ObjectEntities:E}),X=function(t){function i(e){var i=t.call(this)||this;return i.scene=e,i.list=[],i}return e(i,t),Object.defineProperty(i.prototype,"medias",{get:function(){return i},enumerable:!1,configurable:!0}),i.addMedia=function(t,e){return e instanceof HTMLImageElement?this.images.set(t,e):e instanceof HTMLAudioElement?this.audios.set(t,e):e instanceof Text&&this.texts.set(t,e),this},i.prototype.add=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return this.list=s(this.list,e.map((function(e){return e instanceof Function?new e(t.scene,0,0).setManager(t):e.setManager(t)}))).sort((function(t,e){return t.zindex-e.zindex})),this},i.prototype.setEntities=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return this.list=e.map((function(e){return e instanceof P?e.setManager(t):new e(t.scene,0,0).setManager(t)})).sort((function(t,e){return e.zindex-t.zindex})),this},i.prototype.getEntity=function(t){var e=this.list.find((function(e){return e.name===t}));return e||(this.globals.emit("w"+l.Entity,"this entity "+t+" is not create"),new P(this.scene.game.currentScene,0,0))},i.prototype.getAll=function(){return this.list},i.images=new Map,i.audios=new Map,i.texts=new Map,i}(a),I=function(t){function i(e,i){var n=t.call(this)||this;return n.list=[],n.game=e,n.list=i.map((function(t){return t instanceof R?t.setGame(n.game).setManager(n):new t({name:t.name}).setGame(n.game).setManager(n)})),n}return e(i,t),i.create=function(t){return function(e){return new i(e,t)}},i.prototype.play=function(t){return this.game.playScene(this.getScene(t))},i.prototype.playWithOpacity=function(t,e){var i=this.getScene(t);return i.played=!0,i.isPlayed="opacity",i.alpha=y(e,1),this.game.playedWithOpacity.includes(i)||(this.game.playedWithOpacity=s(this.game.playedWithOpacity,[i])),i},i.prototype.getScene=function(t){if("string"==typeof t){if(e=this.list.find((function(e){return e.name===t})))return e;this.globals.emit("w"+l.Scene,"this scene "+t+" is not create")}else if("number"==typeof t){var e;if(e=this.list[t])return e;this.globals.emit("w"+l.Scene,"the "+t+(("1"===(n=(i=t).toString().split(""))[n.length-1]?i+"st":"2"===n[n.length-1]?i+"nd":"3"===n[n.length-1]?i+"rd":i+"th")+" scene has not been created"))}var i,n;return this.list[0]},i}(a),Y=Object.freeze({__proto__:null,AudioManager:x,EntityManager:X,SceneManager:I}),z=function(){function t(t,e){this.isPlaying=!1,this.frame=-1,this.loop=this.loop.bind(this),this.callback=e,this.delay=1e3/t}return t.prototype.loop=function(t){v(this.time)||(this.time=t);var e=Math.floor((t-this.time)/this.delay);e>this.frame&&(this.frame=e,this.callback({time:t,frame:this.frame})),this.tref=requestAnimationFrame(this.loop)},t.prototype.frameRate=function(t){var e=1e3*this.delay;if(!arguments.length)return e;this.delay=1e3/t,this.frame=-1,this.time=null},t.prototype.start=function(){this.isPlaying||(this.isPlaying=!0,this.tref=requestAnimationFrame(this.loop))},t.prototype.pause=function(){this.isPlaying&&(cancelAnimationFrame(this.tref),this.isPlaying=!1,this.time=null,this.frame=-1)},t}(),D=function(t){function i(e,i,n){void 0===i&&(i=800),void 0===n&&(n=600);var s=t.call(this)||this;s.w=i,s.h=n,s.secondsPassed=0,s.oldTimeStamp=0,s.inited=[],s.playedWithOpacity=[],s.debug=e.debug,s.update=s.update.bind(s),s.initScene=s.initScene.bind(s),s.canvas="object"==typeof e.canvas&&e.canvas instanceof HTMLCanvasElement?e.canvas:document.body.appendChild(document.createElement("canvas"));var r=s.canvas.parentNode;s.canvas.width=y(i,r.clientWidth),s.canvas.height=y(n,r.clientHeight);var o=s.canvas.width,a=s.canvas.height;"string"==typeof i&&i.trim().endsWith("%")&&"string"==typeof n&&n.trim().endsWith("%")&&s.globals.on("window:resize",(function(){"string"==typeof i&&i.trim().endsWith("%")&&o!==r.clientWidth&&(s.canvas.width=y(i,r.clientWidth)),"string"==typeof n&&n.trim().endsWith("%")&&a!==r.clientHeight&&(s.canvas.height=y(n,r.clientHeight))})),e.pixel&&(s.canvas.style.imageRendering="Google Inc."===navigator.vendor?"pixelated":"crisp-edges"),s.context=s.canvas.getContext("2d"),s.sceneManager=e.scene(s);var h=Object.keys(e.load||{});if(void 0!==e.loadScene){var c=e.loadScene.forcedLoadingOfEntities||[];h=h.filter((function(t){return!c.includes(t)})),c.forEach((function(t){e.load[t].then((function(e){return X.addMedia(t,e)})).catch((function(t){return s.globals.emit("e"+d.Load,t)}))})),s.playScene(e.loadScene)}return h.forEach((function(t){e.load[t].then((function(e){return X.addMedia(t,e)})).catch((function(t){return s.globals.emit("e"+d.Load,t)}))})),s.sceneManager.play(0),s.loop=new z(240,s.update),s.loop.start(),s.mouse=new O(s),s.keyboard=new G,s.gamepad=new H,s}return e(i,t),i.prototype.playScene=function(t){return(!v(this.currentScene)||this.currentScene.changeAllow(t,u.Next)||v(t)&&t.changeAllow(this.currentScene,u.Prev))&&(t.emit("called",this.currentScene),this.currentScene&&(this.currentScene.played=!1,this.currentScene.isPlayed="none"),t.played=!0,t.isPlayed="main",this.currentScene=t,this.playedWithOpacity=[]),this.currentScene},i.prototype.initScene=function(t,e){if(!this.inited.includes(e.init)){this.inited=s(this.inited,[e.init]),e.init();for(var i=0,n=t;i<n.length;i++){n[i].init()}}if("main"===e.isPlayed)for(var r=0,o=this.playedWithOpacity;r<o.length;r++){var a=o[r];this.initScene(a.entities.getAll(),a)}},i.prototype.update=function(t){var e=this.currentScene.entities.getAll();this.initScene(e,this.currentScene),this.setFPS(t.time),this.mouse.update(),this.emit("updated"),this.globals.emit("window:resize"),this.currentScene.beforeUpdate();for(var i=0,n=e;i<n.length;i++){(y=n[i]).collide(this.mouse)&&y.emit("mouse:hover",y),y.collide(this.mouse)&&this.mouse.click&&y.emit("mouse:click",y),y.beforeRedraw(),y.redraw(this.secondsPassed),y.emit("move:velocity",y)}for(var s=0,r=this.playedWithOpacity;s<r.length;s++){var o=(p=r[s]).entities.getAll();p.beforeUpdate();for(var a=0,h=o;a<h.length;a++){(y=h[a]).collide(this.mouse)&&y.emit("mouse:hover"),y.collide(this.mouse)&&this.mouse.click&&y.emit("mouse:click"),y.beforeRedraw(),y.redraw(this.secondsPassed),y.emit("move:velocity",y)}}this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.save(),this.context.globalAlpha=1,this.context.fillStyle="#000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.restore();for(var c=0,u=e;c<u.length;c++){(y=u[c]).hidden||y.draw(this.context),y.afterRedraw()}for(var l=0,d=this.playedWithOpacity;l<d.length;l++){for(var p,g=0,f=(p=d[l]).entities.getAll();g<f.length;g++){var y;(y=f[g]).draw(this.context),y.afterRedraw()}p.update(this.secondsPassed),p.afterUpdate()}this.context.globalAlpha=1,this.mouse.draw(this.context),this.currentScene.update(this.secondsPassed),this.currentScene.afterUpdate()},i.prototype.setFPS=function(t){this.secondsPassed=(t-this.oldTimeStamp)/1e3,this.oldTimeStamp=t,this.fps=Math.round(1/this.secondsPassed)},i}(a);var q=Object.freeze({__proto__:null,Image:function(t){return new Promise((function(e,i){var n=document.createElement("img");n.src=t,n.onload=function(){return e(n)},n.onerror=i}))},Audio:function(t){return new Promise((function(e,i){var n=document.createElement("audio");n.src=t,n.onloadeddata=function(){return e(n)},n.onerror=i}))},Text:function(t){return new Promise((function(e,i){e(document.createTextNode(t))}))},DOM:function(t){return new Promise((function(e,i){t instanceof HTMLImageElement&&!t.complete||t instanceof HTMLMediaElement&&t.readyState<2?(t.onloadeddata=function(){return e(t)},t.onerror=i):e(t)}))}}),V=new o;document.addEventListener("visibilitychange",(function(){return V.emit("page:visibilitychange")})),window.addEventListener("keydown",(function(t){V.emit("key:down",t.key)})),window.addEventListener("keyup",(function(t){V.emit("key:up",t.key)})),window.addEventListener("gamepadconnected",(function(t){V.emit("gamepad:add",t)})),window.addEventListener("gamepaddisconnected",(function(t){V.emit("gamepad:remove",t)}));var U=function(t){/\d/.test(t)&&V.on("e"+t,(function(e){return console.error("["+d[t]+"]: "+e)}))};for(var N in d)U(N);var F=function(t){/\d/.test(t)&&V.on("w"+t,(function(e){return console.warn("["+l[t]+"]: "+e)}))};for(var N in l)F(N);export{D as Game,q as Loaders,Y as Managers,B as Objects};
