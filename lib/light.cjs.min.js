"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};function e(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return(n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function r(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function i(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function o(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}var s=new Map,a=function(){function t(){this.events=s}return t.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return!!(this.events.has(t)&&this.events.get(t).length>0)&&(this.events.set(t,(this.events.get(t)||[]).map((function(t){return t instanceof Array?t[1]?t:(t[0].apply(t,e),[t[0],!0]):(t.apply(void 0,e),t)}))),!0)},t.prototype.on=function(t,e){return this.events.set(t,o(this.events.get(t)||[],[e])),this},t.prototype.once=function(t,e){return this.events.set(t,o(this.events.get(t)||[],[[e,!1]])),this},t.prototype.off=function(t,e){if(!(this.events.has(t)&&this.events.get(t).length>0))return!1;var n=this.events.get(t);return!!n&&(this.events.set(t,n.filter((function(t){return t!==e}))),0!==n.length||this.events.delete(t))},t.prototype.offAll=function(t){return t?this.events.set(t,[]):this.events.clear(),!0},t}(),c=function(t){function n(){var e=t.call(this)||this;return e.events=new Map,e}return e(n,t),Object.defineProperty(n.prototype,"globals",{get:function(){return new a},enumerable:!1,configurable:!0}),n}(a),u=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=Symbol(null),e.hooks=[],e.hookIndex=0,e}return e(n,t),Object.defineProperty(n,"Types",{get:function(){return this._types},enumerable:!1,configurable:!0}),n.createType=function(t){return this._types[t]=Symbol(t),this},n._types={},n}(c),h=function(t){function n(e,n,r){var i=t.call(this)||this;return i.game=e,i.audio=n,i.key=r,i.isPlaying=!1,i.isPaused=!0,i.isDeleted=!1,i.state={},i.ended=function(){return i.emit("ended")},i.context=new AudioContext,i.changePageVisible=i.changePageVisible.bind(i),i.gain=i.context.createGain(),i.gain.connect(i.context.destination),i.source=i.context.createBufferSource(),i.state.started=!1,i.context.decodeAudioData(i.audio.buffer).then((function(t){i.source.buffer=t,i.source.loop=i.loop,i.source.connect(i.gain),i.source.addEventListener("ended",i.ended)})),i.volume=1,i.speed=1,i.loop=!0,i.globals.on("page:visibilitychange",i.changePageVisible),i}return e(n,t),Object.defineProperty(n.prototype,"loop",{get:function(){return this.state.loop},set:function(t){this.source.loop=t,this.state.loop=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"volume",{get:function(){return this.state.volume},set:function(t){this.gain.gain.value=t,this.state.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"speed",{get:function(){return this.state.speed},set:function(t){this.source.playbackRate.value=t,this.state.speed=t},enumerable:!1,configurable:!0}),n.prototype.play=function(){this.isPaused&&(this.state.started?this.context.resume():(this.source.start(),this.state.started=!0),this.emit("played"),this.isPlaying=!0,this.isPaused=!1)},n.prototype.pause=function(){this.isPlaying&&(this.context.suspend(),this.emit("paused"),this.isPaused=!0,this.isPlaying=!1)},n.prototype.toggle=function(){this.isPlaying?this.pause():this.play()},n.prototype.destroy=function(){this.source.removeEventListener("ended",this.ended),this.source.stop(),this.gain.disconnect(),this.source.disconnect(),this.context.close(),this.globals.off("page:visibilitychange",this.changePageVisible),this.audio=null,this.isDeleted=!0,this.emit("destroy")},n.prototype.changePageVisible=function(){document.hidden&&this.isPlaying?this.context.suspend():!document.hidden&&this.isPlaying&&this.context.resume()},n}(u),l=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.clones=[],e}return e(n,t),n.prototype.createClone=function(){var t=this,e=new h(this.game,this.audio,this.key);return this.clones.push(e),e.on("destroy",(function(){t.clones=t.clones.filter((function(t){return t!==e}))})),e},n.prototype.deletion=function(){this.destroy(),this.clones.forEach((function(t){return t.destroy()})),this.clones=[]},n}(h),f=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype[Symbol.iterator]=function(){var t,e,n;return i(this,(function(r){switch(r.label){case 0:t=Object.entries(this),e=0,n=t,r.label=1;case 1:return e<n.length?[4,n[e]]:[3,4];case 2:r.sent(),r.label=3;case 3:return e++,[3,1];case 4:return[2]}}))},Object.defineProperty(n.prototype,"size",{get:function(){return this.keys().length},enumerable:!1,configurable:!0}),n.prototype.get=function(t,e){return void 0===e&&(e=null),this.has(t)?this[t]:e},n.prototype.set=function(t,e){return this[t]=e,this},n.prototype.has=function(t){return t in this},n.prototype.delete=function(t){return delete this[t]},n.prototype.increment=function(t,e){return void 0===e&&(e=1),this[t]+=e,this},n.prototype.decrement=function(t,e){return void 0===e&&(e=1),this[t]+=e,this},n.prototype.forEach=function(t,e){e&&(t=t.bind(e));for(var n=0,r=Object.entries(this);n<r.length;n++){var i=r[n];t(i[1],i[0],this)}},n.prototype.map=function(t,e){e&&(t=t.bind(e));for(var r=Object.entries(this),i=new n,o=0,s=r;o<s.length;o++){var a=s[o];i.set(a[0],t(a[1],a[0],this))}return i},n.prototype.entries=function(){return this[Symbol.iterator]()},n.prototype.keys=function(){return Object.keys(this)},n.prototype.values=function(){return Object.values(this)},n}(c),d=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t){return"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t,this.y=t),this},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.mul=function(e){return"object"==typeof e?new t(this.x*e.x,this.y*e.y):new t(this.x*e,this.y*e)},t.prototype.div=function(e){return"object"==typeof e?new t(this.x/e.x,this.y/e.y):new t(this.x/e,this.y/e)},t.prototype.add=function(e){return"object"==typeof e?new t(this.x+e.x,this.y+e.y):new t(this.x+e,this.y+e)},t.prototype.sub=function(e){return"object"==typeof e?new t(this.x-e.x,this.y-e.y):new t(this.x-e,this.y-e)},t.prototype.reverse=function(){return this.mul(-1)},t.prototype.abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.length=function(){return Math.sqrt(this.dot(this))},t.prototype.lengthSq=function(){return this.dot(this)},t.prototype.setLength=function(t){return this.normalize().mul(t)},t.prototype.lerp=function(e,n){return new t(this.x+(e.x-this.x)*n,this.y+(e.y-this.y)*n)},t.prototype.normalize=function(){return this.div(this.length())},t.prototype.truncate=function(t){return this.length()>t?this.normalize().mul(t):this},t.prototype.dist=function(t){return Math.sqrt(this.distSq(t))},t.prototype.distSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t}(),p=[["A"],["B"],["X"],["Y"],["Left Bumper","LB"],["Right Bumper","RB"],["Left Trigger","LT"],["Right Trigger","RT"],["Back","View"],["Start"],["Left Stick"],["Right Stick"],["Up","DpadUp"],["Down","DpadDown"],["Left","DpadLeft"],["Right","DpadRight"],["Home","Guide","Xbox"]];var g,y,v,m={left:{label:"Left stick",xAxis:0,yAxis:1},right:{label:"Right stick",xAxis:2,yAxis:3}},b=function(t){function n(e){void 0===e&&(e=navigator);var n=t.call(this)||this;return n.gamepadTimestamp=0,n.navigator=e,n.cgamepad=null,n.store={preferGamepad:!1},n.on("add",(function(t){var e=t.gamepad;if(n.isConnected())return null;"standard"===e.mapping&&(n.cgamepad=e,n.gamepadIndex=e.index,n.store.preferGamepad=!0)})),n.on("remove",(function(t){var e=t.gamepad;if(n.gamepadIndex!==e.index)return null;n.gamepadIndex=void 0,n.store.preferGamepad=!1,n.offAll()})),n}return e(n,t),n.prototype.isConnected=function(){return void 0!==this.gamepadIndex&&this.gamepad.connected},Object.defineProperty(n.prototype,"gamepad",{get:function(){var t=this.navigator.getGamepads()[this.gamepadIndex];return t?(t.timestamp>this.gamepadTimestamp&&(this.store.preferGamepad=!0,this.gamepadTimestamp=t.timestamp),t):this.cgamepad},enumerable:!1,configurable:!0}),n.prototype.button=function(t){var e=this,n=function(t){if("number"==typeof t)return t;for(var e=0,n=0,r=p;n<r.length;n++){for(var i=0,o=r[n];i<o.length;i++){var s=o[i];if(t.toLowerCase()===s.toLowerCase())return e}e++}throw new Error('There is no gamepad button called "'+t+'"!')}(t);return{label:p[n][0],query:function(){return!!e.isConnected()&&e.gamepad.buttons[n].pressed}}},n.prototype.stick=function(t){var e,n=this;if("string"==typeof t){if(!(t in m))throw new Error('Gamepad stick "'+t+'" not found!');e=m[t]}else e=t;return{label:e.label,query:function(){return n.isConnected()?new d(n.gamepad.axes[e.xAxis],n.gamepad.axes[e.yAxis]):new d(0,0)}}},n.prototype.vibrate=function(t,e){var n=void 0===e?{}:e,o=n.weakMagnitude,s=n.strongMagnitude;return r(this,void 0,Promise,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return this.isConnected()&&((e=this.gamepad.vibrationActuator)&&"dual-rumble"===e.type)?[4,e.playEffect("dual-rumble",{duration:t,strongMagnitude:s,weakMagnitude:o})]:[2];case 1:return n.sent(),[2]}}))}))},n}(c),w=new f;function x(t,e){return"number"==typeof t?t:t.trim().endsWith("px")?Number(t.replace(/px$/,"")):t.trim().endsWith("%")?e*(Number(t.replace(/%$/,""))/100):0}function S(t,e){var n="Mouse"===k(e,!0),r="Circle"===k(e),i=e.x,o=e.y;if(t.beginPath(),t.fillStyle="#f00",t.arc(i+(n?0:e.scene.camera.x),o+(n?0:e.scene.camera.y),2,0,2*Math.PI),t.fill(),t.closePath(),r)e.fixed||t.translate(e.scene.camera.x,e.scene.camera.y),t.translate(e.width*e.getScale().x/-2,e.height*e.getScale().y/-2),t.translate(e.radius*-e.getOrigin().x*e.getScale().r,e.radius*-e.getOrigin().y*e.getScale().r),t.beginPath(),t.lineWidth=2,t.strokeStyle="green",t.arc(i,o,e.radius*e.getScale().r,0,2*Math.PI),t.stroke(),t.closePath();else if(!n){var s=e.getBodyBox();e.fixed||t.translate(e.scene.camera.x,e.scene.camera.y),t.translate(e.width*e.getScale().x/-2,e.height*e.getScale().y/-2),t.translate(e.width/2*-e.getOrigin().x*e.getScale().x,e.height/2*-e.getOrigin().y*e.getScale().y),t.lineWidth=2,t.strokeStyle="green",t.strokeRect(i+s.getX(),o+s.getY(),s.getWidth(),s.getHeight())}t.setTransform(1,0,0,1,0,0)}function _(t){return null!=t}function k(t,e){if(void 0===e&&(e=!1),e)return t.constructor.name;if("object"==typeof t||void 0===t){if(null==t)return"undefined";if(t===Promise.prototype)return"Promise";if(void 0!==t[Symbol.toStringTag])return t[Symbol.toStringTag];var n=Object.prototype.toString.call(t).replace(/\[object (.*)\]/,(function(t,e){return e}));return"global"===n||"Window"===n||"DedicatedWorkerGlobalScope"===n||"WorkerGlobalScope"===n?"global":n}return typeof t}function O(t,e){if(t.length!==e.length)return!0;for(var n=0;n<t.length;n++)if(t[n]!==e[n])return!0;return!1}!function(t){t[t.Next=0]="Next",t[t.Prev=1]="Prev"}(g||(g={})),function(t){t[t.Scene=0]="Scene",t[t.Entity=1]="Entity",t[t.Manager=2]="Manager"}(y||(y={})),function(t){t[t.Load=0]="Load",t[t.Audio=1]="Audio",t[t.ClientKey=2]="ClientKey"}(v||(v={}));var I=function(t){function n(e){var n=t.call(this)||this;return n.scene=e,n.list=[],n}return e(n,t),n.prototype.add=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=o(this.list,t.map((function(t){return t instanceof Function?new t:t}))),this},n.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=this.list.filter((function(e){return!t.includes(e)})),this},n.prototype.setManagers=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=t.map((function(t){return t instanceof u?t:new t})),this},n.prototype.getManager=function(t){var e=this.list.find((function(e){return e.name===t}));return e||(this.globals.emit("w"+y.Manager,"this manager "+t+" is not create"),new u)},n.prototype.getAllType=function(t){return this.list.filter((function(e){return e.type.description===t}))},n.prototype.getAll=function(){return this.list},n}(u),j=function(t){function n(e){var n=t.call(this)||this;return n.src=e,fetch(n.src).then((function(t){return t.arrayBuffer()})).then((function(t){n.buffer=t,n.emit("loadeddata")})).catch((function(t){return n.emit("error",t)})),n}return e(n,t),n}(c),E=function(){function t(t,e,n,r,i){this.rebound=!1,"Scene"===k(t)?this.parent=t.world:this.parent=t,this._x=e,this._y=n,this._width=r,this._height=i,this._onlyBorder=!1,this._border={top:0,right:0,bottom:0,left:0}}return Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return"BoundingBox"},enumerable:!1,configurable:!0}),t.prototype.clone=function(){return new t(this.parent,this._x,this._y,this._width,this._height)},Object.defineProperty(t.prototype,"x",{get:function(){return this.getX()},set:function(t){this.setX(t)},enumerable:!1,configurable:!0}),t.prototype.getX=function(){if("number"==typeof this._x)return this._x;if("string"==typeof this._x)return x(this._x,this.parent?this.parent.bounds.getWidth():0);var t=this._x.get();return"number"==typeof t?t:"string"==typeof t?x(t,this.parent?this.parent.bounds.getWidth():0):0},t.prototype.setX=function(t){"object"==typeof this._x?this._x.set(t):this._x=t},Object.defineProperty(t.prototype,"y",{get:function(){return this.getX()},set:function(t){this.setY(t)},enumerable:!1,configurable:!0}),t.prototype.getY=function(){if("number"==typeof this._y)return this._y;if("string"==typeof this._y)return x(this._y,this.parent?this.parent.bounds.getHeight():0);var t=this._y.get();return"number"==typeof t?t:"string"==typeof t?x(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setY=function(t){"object"==typeof this._y?this._y.set(t):this._y=t},Object.defineProperty(t.prototype,"width",{get:function(){return this.getX()},set:function(t){this.setWidth(t)},enumerable:!1,configurable:!0}),t.prototype.getWidth=function(){if("number"==typeof this._width)return this._width;if("string"==typeof this._width)return x(this._width,this.parent?this.parent.bounds.getWidth():0);var t=this._width.get();return"number"==typeof t?t:"string"==typeof t?x(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setWidth=function(t){"object"==typeof this._width?this._width.set(t):this._width=t},Object.defineProperty(t.prototype,"height",{get:function(){return this.getX()},set:function(t){this.setHeight(t)},enumerable:!1,configurable:!0}),t.prototype.getHeight=function(){if("number"==typeof this._height)return this._height;if("string"==typeof this._height)return x(this._height,this.parent?this.parent.bounds.getHeight():0);var t=this._height.get();return"number"==typeof t?t:"string"==typeof t?x(t,this.parent?this.parent.bounds.getHeight():0):0},t.prototype.setHeight=function(t){"object"==typeof this._height?this._height.set(t):this._height=t},t.prototype.moveEntity=function(t){return t.setBox(this),this},t.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&"rebound"===e&&(this.rebound=t[e])},t.prototype.toJSON=function(){return{x:this.getX(),y:this.getY(),width:this.getWidth(),height:this.getHeight(),rebound:this.rebound}},t}(),M=function(t){function n(e){var n=t.call(this)||this,r=null,i=null,o=null,s=null;return n.isActive=!1,n.bounds=new E(n,{get:function(){return r||e.camera.x},set:function(t){r=t}},{get:function(){return i||e.camera.y},set:function(t){i=t}},{get:function(){return o||e.camera.width},set:function(t){o=t}},{get:function(){return s||e.camera.height},set:function(t){s=t}}),n}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"World"},enumerable:!1,configurable:!0}),n.prototype.activation=function(t){this.isActive=t},n.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("boundingBox"===e?this.bounds.fromSave(t[e]):this[e]!==t[e]&&(this[e]=t[e]))},n.prototype.toJSON=function(){return{isActive:this.isActive,boundingBox:this.bounds}},n}(c),P=function(t){function r(e,n,r){var i,o=t.call(this)||this;o.hidden=!1,o.name="",o.lineWidth=1,o.angle=0,o.alpha=1,o.zindex=0,o.fixed=!1,o.hooks=[],o.hookIndex=0,o.originX=0,o.originY=0,o.scalex=1,o.scaley=1,o.bodyBox=null,o.vx=0,o.vy=0,o._speed=1,o._gravity=0,o._bounceWithoutLosingSpeed=!0,o.scene=e,o.box=null===(i=null==e?void 0:e.world)||void 0===i?void 0:i.bounds,o.x=n,o.y=r,o.isMoving=!0;return o.setName(o.constructor.name),o.initBodyBox(e),o.on("move:velocity",(function(t){var e,n,r=.9+(t._bounceWithoutLosingSpeed?.1:0);t.x+=t.vx*t._speed*t.scene.game.secondsPassed,t.y+=t.vy*(t._gravity||t._speed)*t.scene.game.secondsPassed,(null===(n=null===(e=t.box)||void 0===e?void 0:e.parent)||void 0===n?void 0:n.isActive)?"Circle"===k(t)?(t.x-t.box.getX()<t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=Math.abs(t.vx)*r),t.x=t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX+t.box.getX()):t.x-t.box.getX()>t.box.getWidth()+t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=-Math.abs(t.vx)*r),t.x=t.box.getWidth()+t.box.getX()-t.radius*t.getScale().r+t.radius*t.getScale().r*t.originX),t.y-t.box.getY()<t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=Math.abs(t.vy)*r),t.y=t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY-t.box.getY()):t.y-t.box.getY()>t.box.getHeight()+t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=-Math.abs(t.vy)*r),t.y=t.box.getHeight()+t.box.getY()-t.radius*t.getScale().r+t.radius*t.getScale().r*t.originY)):"Rectangle"===k(t)&&(t.x-t.box.getX()<t.width/2*t.scalex+t.width/2*t.scalex*t.originX?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=Math.abs(t.vx)*r),t.x=t.width/2*t.scalex+t.width/2*t.scalex*t.originX+t.box.getX()):t.x-t.box.getX()>t.box.getWidth()-t.width/2*t.scalex+t.width/2*t.scalex*t.originX&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vx=-Math.abs(t.vx)*r),t.x=t.box.getWidth()-t.width/2*t.scalex+t.width/2*t.scalex*t.originX+t.box.getX()),t.y-t.box.getY()<t.height/2*t.scaley+t.height/2*t.scaley*t.originY?(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=Math.abs(t.vy)*r),t.y=t.height/2*t.scaley+t.height/2*t.scaley*t.originY+t.box.getY()):t.y-t.box.getY()>t.box.getHeight()-t.height/2*t.scaley+t.height/2*t.scaley*t.originY&&(t.isMoving&&(t.isMoving=!1),t.box.rebound&&(t.vy=-Math.abs(t.vy)*r),t.y=t.box.getHeight()-t.height/2*t.scaley+t.height/2*t.scaley*t.originY+t.box.getY())):t.isMoving&&(t.isMoving=!1)})),o}return e(r,t),Object.defineProperty(r.prototype,"points",{get:function(){return[]},enumerable:!1,configurable:!0}),r.prototype.init=function(){},r.prototype.beforeRedraw=function(){},r.prototype.redraw=function(t){},r.prototype.afterRedraw=function(){},r.prototype.draw=function(t){},r.prototype.destroy=function(){this.manager.remove(this)},r.prototype.setBox=function(t){return this.box=t,this},Object.defineProperty(r.prototype,"body",{get:function(){return this.getBodyBox()},set:function(t){this.setBodyBox(t)},enumerable:!1,configurable:!0}),r.prototype.setBodyBox=function(t){return t?this.bodyBox=t:this.initBodyBox(this.scene),this},r.prototype.getBodyBox=function(){return this.bodyBox},r.prototype.collide=function(t){var e,n,r,i;return"World"===k(t)||"BoundingBox"===k(t)?"Circle"===k(this)?this.collideCircWorld(this,null!==(n=null===(e=t)||void 0===e?void 0:e.bounds)&&void 0!==n?n:t):"Rectangle"===k(this)&&this.collideRectWorld(this,null!==(i=null===(r=t)||void 0===r?void 0:r.bounds)&&void 0!==i?i:t):"Circle"===k(this)&&"Circle"===k(t)?this.collideCirc(this,t):"Rectangle"===k(this)&&"Rectangle"===k(t)?this.collideRect(this,t):"Circle"===k(this)&&"Rectangle"===k(t)?this.collideCircRect(this,t):"Rectangle"===k(this)&&"Circle"===k(t)&&this.collideCircRect(t,this)},r.prototype.setScaleX=function(t){return this.scalex!==t&&(this.scalex=t),this},r.prototype.setScaleY=function(t){return this.scaley!==t&&(this.scaley=t),this},r.prototype.setScale=function(t,e){return this.setScaleX(t),this.setScaleY(null!=e?e:t),this},r.prototype.getScale=function(){return{x:this.scalex,y:this.scaley}},r.prototype.setOriginX=function(t){return this.originX!==t&&(this.originX=t),this},r.prototype.setOriginY=function(t){return this.originY!==t&&(this.originY=t),this},r.prototype.setOrigin=function(t,e){return this.setOriginX(t),this.setOriginY(null!=e?e:t),this},r.prototype.getOrigin=function(){return{x:this.originX,y:this.originY}},r.prototype.setVelocityX=function(t){return this.vx!==t&&(this.vx=t),this},r.prototype.setVelocityY=function(t){return this.vy!==t&&(this.vy=t),this},r.prototype.setVelocity=function(t,e){return this.setVelocityX(t),this.setVelocityY(e),this},r.prototype.getVelocity=function(){return{x:this.vx,y:this.vy}},r.prototype.getSpeed=function(){return this._speed},r.prototype.setSpeed=function(t){return this._speed!==t&&(this._speed=t),this},r.prototype.getGravity=function(){return this._gravity},r.prototype.setGravity=function(t){return this._gravity!==t&&(this._gravity=t),this},r.prototype.setManager=function(t){return this.manager=t,this},r.prototype.setBounceWithoutLosingSpeed=function(t){return this._bounceWithoutLosingSpeed=t,this},r.prototype.setName=function(t){return this.name=t,this},r.prototype.getAudio=function(t){return this.scene.getAudio(t)},r.prototype.collideCirc=function(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<=Math.pow(t.radius*t.getScale().r+e.radius*e.getScale().r,2)},r.prototype.collideRect=function(t,e){var n=t.getBodyBox(),r=t.x+n.getX()+t.width/2*-t.getOrigin().x*t.getScale().x,i=t.y+n.getY()+t.height/2*-t.getOrigin().y*t.getScale().y;if(!e.getBodyBox)return!(r-n.getWidth()/2>e.width+e.x-e.width/2||e.x-e.width/2>n.getWidth()+r-n.getWidth()/2||i-n.getHeight()/2>e.height+e.y-e.height/2||e.y-e.height/2>n.getHeight()+i-n.getHeight()/2);var o=e.getBodyBox(),s=e.x+o.getX()+e.width/2*-e.getOrigin().x*e.getScale().x,a=e.y+o.getY()+e.height/2*-e.getOrigin().y*e.getScale().y;return!(r-n.getWidth()/2>o.getWidth()+s-o.getWidth()/2||s-o.getWidth()/2>n.getWidth()+r-n.getWidth()/2||i-n.getHeight()/2>o.getHeight()+a-o.getHeight()/2||a-o.getHeight()/2>n.getHeight()+i-n.getHeight()/2)},r.prototype.collideCircRect=function(t,e){var n=Math.abs(t.x-e.x-e.width/2),r=Math.abs(t.y-e.y-e.height/2);return!(n>e.width/2+t.radius*t.getScale().r||r>e.height/2+t.radius*t.getScale().r)&&(n<=e.width/2||r<=e.height/2||Math.pow(n-e.width/2,2)+Math.pow(r-e.height/2,2)<=t.radius*Math.pow(t.getScale().r,2))},r.prototype.collideCircWorld=function(t,e){var n=Math.abs(t.x-e.getX()),r=Math.abs(t.y-e.getY());return!(n>e.getWidth()+t.radius*t.getScale().r||r>e.getHeight()+t.radius*t.getScale().r)&&(n<=e.getWidth()||r<=e.getHeight()||Math.pow(n-e.getWidth(),2)+Math.pow(r-e.getHeight(),2)<=t.radius*Math.pow(t.getScale().r,2))},r.prototype.collideRectWorld=function(t,e){var n=t.getBodyBox();return!(t.x+n.getX()-n.getWidth()/2>e.getWidth()+e.getX()||e.getX()>n.getWidth()+(t.x+n.getX())||t.y+n.getY()-n.getHeight()/2>e.getHeight()+e.getY()||e.getY()>n.getHeight()+(t.y+n.getY()))},r.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&this[e]!==t[e]&&(this[e]=t[e])},r.prototype.toJSON=function(t){var e=this,r={};return t.forEach((function(t){r[t]=t in e?e[t]:null})),n({x:this.x,y:this.y,name:this.name},r)},r.prototype.initBodyBox=function(t){var e=0,n=0,r=null,i=null,o=this;this.setBodyBox(new E(t,{get:function(){return e},set:function(t){e=t}},{get:function(){return n},set:function(t){n=t}},{get:function(){return(r||o.width)*o.scalex},set:function(t){r=t}},{get:function(){return(i||o.height)*o.scaley},set:function(t){i=t}}))},r}(c),A=function(t){function n(e,n,r,i,o){var s=t.call(this,e,n,r)||this;return s.cropw=1,s.croph=1,s.width=i,s.height=o,s.fillColor="#fff",s}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"points",{get:function(){var t=this.x+this.body.getX()+this.width/2*-this.getOrigin().x*this.getScale().x,e=this.y+this.body.getY()+this.height/2*-this.getOrigin().y*this.getScale().y;return[new d(t,e),new d(t+this.body.width,e),new d(t,e+this.body.height),new d(t+this.body.width,e+this.body.height)]},enumerable:!1,configurable:!0}),n.prototype.draw=function(t){t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),_(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),t.fillRect(this.x,this.y,this.width,this.height)),_(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.strokeRect(this.x,this.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},n.prototype.setCropW=function(t){return this.cropw!==t&&(this.cropw=t),this},n.prototype.setCropH=function(t){return this.croph!==t&&(this.croph=t),this},n.prototype.setCrop=function(t,e){return void 0===t&&(t=1),void 0===e&&(e=1),this.setCropW(t),this.setCropH(e),this},n.prototype.getCrop=function(){return{w:this.cropw,h:this.croph}},n}(P),C=function(t){function n(e,n,r,i){var o=t.call(this,e,n,r)||this;return o.scaler=1,delete o.width,delete o.height,delete o.scalex,delete o.scaley,delete o.setScaleX,delete o.setScaleY,o.radius=i,o.angle=360,o.fillColor="#fff",o}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"Circle"},enumerable:!1,configurable:!0}),n.prototype.setScaleR=function(t){return this.scaler=t,this},n.prototype.getScale=function(){return{r:this.scaler}},n.prototype.draw=function(t){var e=2*Math.PI*(this.angle/360);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.radius*-this.originX*this.scaler,this.radius*-this.originY*this.scaler),_(this.fillColor)&&(t.beginPath(),t.fillStyle=this.fillColor.toString(16),t.arc(this.x,this.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.fill(),t.closePath()),_(this.strokeColor)&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),t.arc(this.x,this.y,this.radius*this.scaler,0,Math.abs(e),e>=0),t.stroke(),t.closePath()),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},n}(P),N=function(t){function n(e,n,r,i){var o=t.call(this,e,n,r,null,null)||this;return o.use=i,o}return e(n,t),n.prototype.setSize=function(t){this.width=t.width,this.height=t.height},n.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),_(e)&&(_(this.width)||_(this.height)||this.setSize(e),t.drawImage(e,0,0,this.width*this.cropw,this.height*this.croph,this.x-this.scene.camera.x,this.y-this.scene.camera.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},n}(A),B=function(t){function r(e,n,r,i){var o=t.call(this,e,n,r,i)||this;return o.sprite={x:0,y:0,width:0,height:0},o}return e(r,t),r.prototype.draw=function(t){var e=this.manager.medias.images.get(this.use);t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),_(e)&&(_(this.width)||_(this.height)||this.setSize(this.sprite),t.drawImage(e,this.sprite.x,this.sprite.y,this.sprite.width*this.cropw,this.sprite.height*this.croph,this.x,this.y,this.width*this.scalex*this.cropw,this.height*this.scaley*this.croph)),t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},r.prototype.toJSON=function(e){return n(n({},t.prototype.toJSON.call(this,e)),{sprite:this.sprite})},r}(N),R=function(t){function r(e,n,r,i,o){var s=t.call(this,e,n,r,null,null)||this;return s.content=i,s.style=Object.assign({shadow:null,lineSpacing:6,background:null,align:"center",padding:null,font:null},o),s.style.shadow=Object.assign({offsetX:0,offsetY:0,color:"#000",blur:0},s.style.shadow),s.style.padding=Object.assign({left:0,right:0,top:0,bottom:0},s.style.padding),s.style.font=Object.assign({size:16,family:"Arial"},s.style.font),s}return e(r,t),r.prototype.draw=function(t){var e=this,n=0;if("right"===this.style.align&&(n=this.width/-2),"left"===this.style.align&&(n=this.width/2),t.globalAlpha=this.alpha*("opacity"===this.scene.isPlayed?this.scene.alpha:1),this.fixed||t.translate(this.scene.camera.x,this.scene.camera.y),t.textBaseline="top",t.font=this.style.font.size+"px "+this.style.font.family,this.height=this.content.split("\n").reduce((function(n,r,i){return 0===i?(e.width=t.measureText(r.trim()).width,e.style.font.size):(e.width<t.measureText(r.trim()).width&&(e.width=t.measureText(r.trim()).width),n+e.style.lineSpacing+e.style.font.size)}),0),t.translate(this.width*this.scalex/-2,this.height*this.scaley/-2),t.translate(this.width/2*-this.originX*this.scalex,this.height/2*-this.originY*this.scaley),_(this.style.background))if(this.style.background instanceof P||this.manager.medias.images.get(this.style.background)instanceof P){var r="string"===k(this.style.background)?this.manager.medias.images.get(this.style.background):this.style.background;r.getScale().x===this.getScale().x&&r.getScale().y===this.getScale().y||r.setScale(this.getScale().x,this.getScale().y),r.getOrigin().x===this.getOrigin().x&&r.getOrigin().y===this.getOrigin().y||r.setOrigin(this.getOrigin().x,this.getOrigin().y),r.box!==this.box&&r.setBox(this.box),r.x!==this.x&&(r.x=this.x),r.y!==this.y&&(r.y=this.y)}else t.fillStyle=this.style.background.toString(16),t.fillRect(this.x,this.y,this.width+this.style.padding.left+this.style.padding.right,this.height+this.style.padding.top+this.style.padding.bottom);_(this.fillColor)&&(t.fillStyle=this.fillColor.toString(16),this.content.split("\n").forEach((function(r,i){t.fillText(r.trim(),e.x+e.style.padding.left+n,e.y+e.style.padding.top+(e.style.lineSpacing+e.style.font.size)*i)}),0)),_(this.strokeColor)&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor.toString(16),this.content.split("\n").forEach((function(r,i){t.strokeText(r.trim(),e.x+e.style.padding.left+n,e.y+e.style.padding.top+(e.style.lineSpacing+e.style.font.size)*i)}),0)),t.shadowBlur=this.style.shadow.blur,t.shadowColor=this.style.shadow.color.toString(16),t.shadowOffsetX=this.style.shadow.offsetX,t.shadowOffsetY=this.style.shadow.offsetY,t.setTransform(1,0,0,1,0,0),this.scene.game.debug&&S(t,this)},r.prototype.getScale=function(){return{x:1,y:1}},r.prototype.setText=function(t){return this.content=t,this},r.prototype.toJSON=function(e){return n(n({},t.prototype.toJSON.call(this,e)),{content:this.content})},r}(A),T=function(t){function n(e){var n=t.call(this,e,0,0,0,0)||this;return n.setName("camera"),n.offAll("move:velocity"),n}return e(n,t),n.prototype.init=function(){this.center=new E(this.scene,"50%","50%",2,2),this.width=this.scene.game.canvas.width,this.height=this.scene.game.canvas.height},n.prototype.draw=function(){},n.prototype.setValues=function(t,e,n,r){return _(t)&&(this.x=t),_(e)&&(this.y=e),_(n)&&(this.width=n),_(r)&&(this.height=r),this},n.prototype.setTarget=function(t){return this.target="string"==typeof t?this.scene.entities.getEntity(t):t,this},n.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("targetName"===e?this.target=this.manager.getEntity(t[e]):"center"===e?(this.center||"BoundingBox"===k(this.center)||(this.center=new E(this.scene,t[e].x,t[e].y,t[e].width,t[e].height)),this.center.fromSave(t[e])):this[e]!==t[e]&&(this[e]=t[e]))},n.prototype.toJSON=function(){var t;return{x:this.x,y:this.y,name:this.name,width:this.width,height:this.height,targetName:null===(t=this.target)||void 0===t?void 0:t.name,center:this.center}},n}(A),W=Object.freeze({__proto__:null,Rectangle:A,Circle:C,Image:N,Sprite:B,Text:R,Camera:T}),L=function(t){function n(e,n,r,i){void 0===i&&(i=!1);var o=t.call(this)||this;return o.scene=e,o.callback=n,o.unique=i,o.isPlaying=!1,o.wait=0,o.update=o.update.bind(o),o.scene.game.globals.on("updated",o.update),o.setTimeWait(r),o}return e(n,t),n.prototype.getWaitValue=function(){return this.wait},n.prototype.setWaitValue=function(t){return this.wait=t,this},n.prototype.setTimeWait=function(t){return this.useTime="time"in t,this.useTick="tick"in t,this.time=t.time,this.tick=t.tick,this.setWaitValue(0)},n.prototype.update=function(){this.isPlaying&&(this.useTime?(this.setWaitValue(this.wait+1e3*this.scene.game.secondsPassed),this.time<=this.wait&&(this.callback(),this.unique?this.cancel():this.setWaitValue(0))):this.useTick&&(this.setWaitValue(this.wait+1),this.tick<=this.wait&&(this.callback(),this.unique?this.cancel():this.setWaitValue(0))))},n.prototype.cancel=function(){this.scene.game.globals.off("updated",this.update),this.pause()},n.prototype.play=function(){this.isPlaying||(this.isPlaying=!0)},n.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1)},n}(c),D=new Map,X=function(t){function n(e){var n=t.call(this)||this;n.forcedLoadingOfEntities=[],n.hooks=[],n.hookIndex=0,n.managers=new I(n),n.entities=new V(n),n.world=new M(n),n.name=e.name,n.isPlayed="none",n.played=!1,n.alpha=1;var r=n;return n.create={box:function(t,e,n,i,o){void 0===o&&(o=[]);var s=new E(r.world,t,e,n,i);return o.forEach((function(t){return s.moveEntity(t)})),s},timer:function(t,e,n){return void 0===n&&(n=!1),new L(r,t,e,n)},entity:{rectangle:function(t,e,n,i,o,s){void 0===s&&(s=0);var a=new A(r,t,e,n,i);return a.zindex=s,a.fillColor=o,r.entities.add(a),a},circle:function(t,e,n,i,o){void 0===o&&(o=0);var s=new C(r,t,e,n);return s.zindex=o,s.fillColor=i,r.entities.add(s),s},image:function(t,e,n,i){void 0===i&&(i=0);var o=new N(r,t,e,n);return o.zindex=i,r.entities.add(o),o},sprite:function(t,e,n,i,o,s){void 0===s&&(s=0);var a=new B(r,t,e,n);return a.sprite.width=i,a.sprite.height=o,a.zindex=s,r.entities.add(a),a},text:function(t,e,n,i,o){void 0===i&&(i={}),void 0===o&&(o=0);var s=new R(r,t,e,n,i);return s.zindex=o,r.entities.add(s),s}}},n.camera=new T(n),n.entities.add(n.camera),n}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"Scene"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},n.prototype.beforeUpdate=function(){},n.prototype.update=function(t){},n.prototype.afterUpdate=function(){},n.prototype.changeAllow=function(t,e){return!0},n.prototype.getAudio=function(t){if(D.has(t)&&!D.get(t).isDeleted)return D.get(t);var e=this.entities.medias.audios.get(t);if(e){var n=new l(this.game,e,t);return D.set(t,n),n.on("destroy",(function(){D.delete(t)})),n}return null},n.prototype.setName=function(t){return this.name=t,this},n.prototype.setGame=function(t){return this.game=t,this},n.prototype.setManager=function(t){return this.manager=t,this},n.prototype.fromSave=function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&("entities"===e?this.entities.getAll().map((function(e){var n=t.entities.find((function(t){return t.name===e.name}));n&&e.fromSave(n)})):"camera"===e?this.camera.fromSave(t[e]):"world"===e?this.world.fromSave(t[e]):this[e]!==t[e]&&(this[e]=t[e]))},n.prototype.toJSON=function(t){return{name:this.name,world:this.world,camera:this.camera,alpha:this.alpha,entities:this.entities.getAll().filter((function(e){return"camera"!==e.name&&("object"!=typeof t||!t.exclude.entities.includes(e.name))})).map((function(e){return e.toJSON(t.entityProperties||[])}))}},n}(c),z=function(t){function n(e){var n=t.call(this)||this;n.x=0,n.y=0,n.width=1,n.height=1,n.click=!1,n.currentClickPos=new Map;var r=["left","center","right"];return n.game=e,e.canvas.addEventListener("mousedown",(function(t){n.click=!0,n.currentClickPos.set(r[t.button],t),n.globals.emit("mouse:down-"+r[t.button],t)})),e.canvas.addEventListener("mousemove",(function(t){n.x=t.offsetX,n.y=t.offsetY,n.globals.emit("mouse:move",t)})),e.canvas.addEventListener("mouseup",(function(t){n.click=!1,n.currentClickPos.delete(r[t.button]),n.globals.emit("mouse:up-"+r[t.button],t)})),e.canvas.addEventListener("touchstart",(function(t){var r=e.canvas.getBoundingClientRect();n.x=t.touches[0].clientX-r.left,n.y=t.touches[0].clientY-r.top,n.click=!0,n.currentClickPos.set("left",t),n.globals.emit("mouse:down-left",t)})),e.canvas.addEventListener("touchmove",(function(t){var r=e.canvas.getBoundingClientRect();n.x=t.touches[0].clientX-r.left,n.y=t.touches[0].clientY-r.top,n.globals.emit("mouse:move",t)})),e.canvas.addEventListener("touchend",(function(t){n.click=!1,n.currentClickPos.delete("left"),n.globals.emit("mouse:up-left",t)})),n}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"Rectangle"},enumerable:!1,configurable:!0}),n.prototype.update=function(){var t=this;this.currentClickPos.forEach((function(e,n){t.globals.emit("mouse:down-"+n,e)}))},n.prototype.draw=function(t){t.setTransform(1,0,0,1,0,0),this.game.debug&&S(t,this)},n}(c),Y={" ":["Space","Spacebar","Space Bar"],AltGraph:["Alt Gr"],ArrowDown:["Down"],ArrowLeft:["Left"],ArrowRight:["Right"],ArrowUp:["Up"],Backspace:["Backspace"],Control:["Ctrl","Ctl"],Delete:["Delete","Del"],Enter:["Enter","Return"],Escape:["Escape","Esc"],Insert:["Insert","Ins"],PageDown:["Page Down","PgDown"],PageUp:["Page Up","PgUp"],Tab:["Tab"]},H={arrows:["ArrowUp","ArrowLeft","ArrowDown","ArrowRight"],wasd:["W","A","S","D"],zqsd:["Z","Q","S","D"]},F=function(t){function n(){var e=t.call(this)||this;return e.pressed=new Set,e.globals.on("key:down",(function(t){var n=!1;for(var r in Y)if(Y[r].includes(t)){e.pressed.add(r.toLowerCase()),n=!0;break}n||e.pressed.add(t.toLowerCase())})),e.globals.on("key:up",(function(t){for(var n in Y)if(Y[n].includes(t)){e.pressed.delete(n.toLowerCase());break}e.pressed.delete(t.toLowerCase())})),e}return e(n,t),n.prototype.query=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return e.reduce((function(e,n){return e&&t.pressed.has(n.toLowerCase())}),!0)&&e.length>0},n.prototype.vectorQuery=function(t){if("string"==typeof t&&t.toLocaleLowerCase()in H){var e=new d(0,0);return this.query(H[t][0])&&(e.y-=1),this.query(H[t][1])&&(e.x-=1),this.query(H[t][2])&&(e.y+=1),this.query(H[t][3])&&(e.x+=1),e}if(t instanceof Array){e=new d(0,0);return this.query(t[0])&&(e.y-=1),this.query(t[1])&&(e.x-=1),this.query(t[2])&&(e.y+=1),this.query(t[3])&&(e.x+=1),e}return new d(0,0)},n}(c),q=function(t){function n(){var e=t.call(this)||this;return e.gamepads=[],e.globals.on("gamepad:add",(function(t){var n=new b;n.emit("add",t),e.gamepads=o(e.gamepads,[n])})),e.globals.on("gamepad:remove",(function(t){e.gamepads=e.gamepads.filter((function(e){return e.gamepad.id!==t.gamepad.id||(e.emit("remove",t),!1)}))})),e.pressed=new Set,e.withGamepad(0),e}return e(n,t),Object.defineProperty(n.prototype,"currentGamepad",{get:function(){return this.gamepads[this.gamepadIndex]},enumerable:!1,configurable:!0}),n.prototype.withGamepad=function(t){this.gamepadIndex=t},n.prototype.query=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return e.reduce((function(e,n){return!(t.gamepads.length<=t.gamepadIndex)&&(e&&t.currentGamepad.button(n).query())}),!0)&&e.length>0},n.prototype.vectorQuery=function(t){if("string"==typeof t&&this.gamepads.length>this.gamepadIndex){var e=this.currentGamepad.stick(t).query();return new d(Math.round(1e4*e.x)/1e4,Math.round(1e4*e.y)/1e4)}return new d(0,0)},n.prototype.vibrate=function(t,e){var n=void 0===e?{}:e,o=n.weakMagnitude,s=n.strongMagnitude;return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.currentGamepad.vibrate(t,{weakMagnitude:o,strongMagnitude:s})];case 1:return e.sent(),[2]}}))}))},n}(c),G=function(t){function n(e){var n=t.call(this)||this;return n.objectStore=e,n}return e(n,t),n.prototype.size=function(){return this.objectStore.length()},n.prototype.set=function(t,e){return _(e)?this.objectStore.setItem(t,e):this.delete(t),this},n.prototype.get=function(t){return this.objectStore.getItem(t)},n.prototype.has=function(t){return r(this,void 0,Promise,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.objectStore.getItem(t)];case 1:return[2,_(e.sent())]}}))}))},n.prototype.delete=function(t){return this.objectStore.removeItem(t)},n.prototype.toObject=function(){return r(this,void 0,Promise,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return t={},[4,this.objectStore.iterate((function(e,n){t[n]=e}))];case 1:return e.sent(),[2,t]}}))}))},n}(c),U=Object.freeze({__proto__:null,AudioLoader:j,Scene:X,Entity:P,World:M,BoundingBox:E,Mouse:z,Keyboard:F,Gamepad:q,Timer:L,Store:G,Storage:f,Vector2:d,ObjectEntities:W}),V=function(t){function n(e){var n=t.call(this)||this;return n.scene=e,n.list=[],n}return e(n,t),Object.defineProperty(n.prototype,"medias",{get:function(){return n},enumerable:!1,configurable:!0}),n.addMedia=function(t,e){return e instanceof HTMLImageElement?this.images.set(t,e):e instanceof j?this.audios.set(t,e):e instanceof Text&&this.texts.set(t,e),this},n.prototype.add=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return this.list=o(this.list,e.map((function(e){return e instanceof Function?new e(t.scene,0,0).setManager(t):e.setManager(t)}))).sort((function(t,e){return t.zindex-e.zindex})),this},n.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.list=this.list.filter((function(e){return!t.includes(e)})),this},n.prototype.setEntities=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return this.list=e.map((function(e){return e instanceof P?e.setManager(t):new e(t.scene,0,0).setManager(t)})).sort((function(t,e){return e.zindex-t.zindex})),this},n.prototype.getEntity=function(t){var e=this.list.find((function(e){return e.name===t}));return e||(this.globals.emit("w"+y.Entity,"this entity "+t+" is not create"),new P(this.scene.game.currentScene,0,0))},n.prototype.getAll=function(){return this.list},n.images=new Map,n.audios=new Map,n.texts=new Map,n}(u),J="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function K(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}var Q=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){
/*!
    localForage -- Offline Storage, Improved
    Version 1.9.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/
t.exports=function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){if(!a&&K)return K();if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};e[s][0].call(u.exports,(function(t){var n=e[s][1][t];return i(n||t)}),u,u.exports,t,e,n,r)}return n[s].exports}for(var o=K,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t,e,n){(function(t){var n,r,i=t.MutationObserver||t.WebKitMutationObserver;if(i){var o=0,s=new i(h),a=t.document.createTextNode("");s.observe(a,{characterData:!0}),n=function(){a.data=o=++o%2}}else if(t.setImmediate||void 0===t.MessageChannel)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){h(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(h,0)};else{var c=new t.MessageChannel;c.port1.onmessage=h,n=function(){c.port2.postMessage(0)}}var u=[];function h(){var t,e;r=!0;for(var n=u.length;n;){for(e=u,u=[],t=-1;++t<n;)e[t]();n=u.length}r=!1}e.exports=function(t){1!==u.push(t)||r||n()}}).call(this,void 0!==J?J:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(t,e,n){var r=t(1);function i(){}var o={},s=["REJECTED"],a=["FULFILLED"],c=["PENDING"];function u(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,t!==i&&d(this,t)}function h(t,e,n){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function l(t,e,n){r((function(){var r;try{r=e(n)}catch(e){return o.reject(t,e)}r===t?o.reject(t,new TypeError("Cannot resolve promise with itself")):o.resolve(t,r)}))}function f(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments)}}function d(t,e){var n=!1;function r(e){n||(n=!0,o.reject(t,e))}function i(e){n||(n=!0,o.resolve(t,e))}var s=p((function(){e(i,r)}));"error"===s.status&&r(s.value)}function p(t,e){var n={};try{n.value=t(e),n.status="success"}catch(t){n.status="error",n.value=t}return n}e.exports=u,u.prototype.catch=function(t){return this.then(null,t)},u.prototype.then=function(t,e){if("function"!=typeof t&&this.state===a||"function"!=typeof e&&this.state===s)return this;var n=new this.constructor(i);return this.state!==c?l(n,this.state===a?t:e,this.outcome):this.queue.push(new h(n,t,e)),n},h.prototype.callFulfilled=function(t){o.resolve(this.promise,t)},h.prototype.otherCallFulfilled=function(t){l(this.promise,this.onFulfilled,t)},h.prototype.callRejected=function(t){o.reject(this.promise,t)},h.prototype.otherCallRejected=function(t){l(this.promise,this.onRejected,t)},o.resolve=function(t,e){var n=p(f,e);if("error"===n.status)return o.reject(t,n.value);var r=n.value;if(r)d(t,r);else{t.state=a,t.outcome=e;for(var i=-1,s=t.queue.length;++i<s;)t.queue[i].callFulfilled(e)}return t},o.reject=function(t,e){t.state=s,t.outcome=e;for(var n=-1,r=t.queue.length;++n<r;)t.queue[n].callRejected(e);return t},u.resolve=function(t){return t instanceof this?t:o.resolve(new this(i),t)},u.reject=function(t){var e=new this(i);return o.reject(e,t)},u.all=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var n=t.length,r=!1;if(!n)return this.resolve([]);for(var s=new Array(n),a=0,c=-1,u=new this(i);++c<n;)h(t[c],c);return u;function h(t,i){e.resolve(t).then((function(t){s[i]=t,++a!==n||r||(r=!0,o.resolve(u,s))}),(function(t){r||(r=!0,o.reject(u,t))}))}},u.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var n=t.length,r=!1;if(!n)return this.resolve([]);for(var s,a=-1,c=new this(i);++a<n;)s=t[a],e.resolve(s).then((function(t){r||(r=!0,o.resolve(c,t))}),(function(t){r||(r=!0,o.reject(c,t))}));return c}},{1:1}],3:[function(t,e,n){(function(e){"function"!=typeof e.Promise&&(e.Promise=t(2))}).call(this,void 0!==J?J:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(t,e,n){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(t){return}}();function o(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(i){if("TypeError"!==i.name)throw i;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),r=0;r<t.length;r+=1)n.append(t[r]);return n.getBlob(e.type)}}"undefined"==typeof Promise&&t(3);var s=Promise;function a(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}function c(t,e,n){"function"==typeof e&&t.then(e),"function"==typeof n&&t.catch(n)}function u(t){return"string"!=typeof t&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function h(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var l=void 0,f={},d=Object.prototype.toString;function p(t){return"boolean"==typeof l?s.resolve(l):function(t){return new s((function(e){var n=t.transaction("local-forage-detect-blob-support","readwrite"),r=o([""]);n.objectStore("local-forage-detect-blob-support").put(r,"key"),n.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1)},n.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);e(n||!t||parseInt(t[1],10)>=43)}})).catch((function(){return!1}))}(t).then((function(t){return l=t}))}function g(t){var e=f[t.name],n={};n.promise=new s((function(t,e){n.resolve=t,n.reject=e})),e.deferredOperations.push(n),e.dbReady?e.dbReady=e.dbReady.then((function(){return n.promise})):e.dbReady=n.promise}function y(t){var e=f[t.name].deferredOperations.pop();if(e)return e.resolve(),e.promise}function v(t,e){var n=f[t.name].deferredOperations.pop();if(n)return n.reject(e),n.promise}function m(t,e){return new s((function(n,r){if(f[t.name]=f[t.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},t.db){if(!e)return n(t.db);g(t),t.db.close()}var o=[t.name];e&&o.push(t.version);var s=i.open.apply(i,o);e&&(s.onupgradeneeded=function(e){var n=s.result;try{n.createObjectStore(t.storeName),e.oldVersion<=1&&n.createObjectStore("local-forage-detect-blob-support")}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+t.name+'" has been upgraded from version '+e.oldVersion+" to version "+e.newVersion+', but the storage "'+t.storeName+'" already exists.')}}),s.onerror=function(t){t.preventDefault(),r(s.error)},s.onsuccess=function(){n(s.result),y(t)}}))}function b(t){return m(t,!1)}function w(t){return m(t,!0)}function x(t,e){if(!t.db)return!0;var n=!t.db.objectStoreNames.contains(t.storeName),r=t.version<t.db.version,i=t.version>t.db.version;if(r&&(t.version!==e&&console.warn('The database "'+t.name+"\" can't be downgraded from version "+t.db.version+" to version "+t.version+"."),t.version=t.db.version),i||n){if(n){var o=t.db.version+1;o>t.version&&(t.version=o)}return!0}return!1}function S(t){return o([function(t){for(var e=t.length,n=new ArrayBuffer(e),r=new Uint8Array(n),i=0;i<e;i++)r[i]=t.charCodeAt(i);return n}(atob(t.data))],{type:t.type})}function _(t){return t&&t.__local_forage_encoded_blob}function k(t){var e=this,n=e._initReady().then((function(){var t=f[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}));return c(n,t,t),n}function O(t,e,n,r){void 0===r&&(r=1);try{var i=t.db.transaction(t.storeName,e);n(null,i)}catch(i){if(r>0&&(!t.db||"InvalidStateError"===i.name||"NotFoundError"===i.name))return s.resolve().then((function(){if(!t.db||"NotFoundError"===i.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),w(t)})).then((function(){return function(t){g(t);for(var e=f[t.name],n=e.forages,r=0;r<n.length;r++){var i=n[r];i._dbInfo.db&&(i._dbInfo.db.close(),i._dbInfo.db=null)}return t.db=null,b(t).then((function(e){return t.db=e,x(t)?w(t):e})).then((function(r){t.db=e.db=r;for(var i=0;i<n.length;i++)n[i]._dbInfo.db=r})).catch((function(e){throw v(t,e),e}))}(t).then((function(){O(t,e,n,r-1)}))})).catch(n);n(i)}}var I={_driver:"asyncStorage",_initStorage:function(t){var e=this,n={db:null};if(t)for(var r in t)n[r]=t[r];var i=f[n.name];i||(i={forages:[],db:null,dbReady:null,deferredOperations:[]},f[n.name]=i),i.forages.push(e),e._initReady||(e._initReady=e.ready,e.ready=k);var o=[];function a(){return s.resolve()}for(var c=0;c<i.forages.length;c++){var u=i.forages[c];u!==e&&o.push(u._initReady().catch(a))}var h=i.forages.slice(0);return s.all(o).then((function(){return n.db=i.db,b(n)})).then((function(t){return n.db=t,x(n,e._defaultConfig.version)?w(n):t})).then((function(t){n.db=i.db=t,e._dbInfo=n;for(var r=0;r<h.length;r++){var o=h[r];o!==e&&(o._dbInfo.db=n.db,o._dbInfo.version=n.version)}}))},_support:function(){try{if(!i||!i.open)return!1;var t="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),e="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!t||e)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(t){return!1}}(),iterate:function(t,e){var n=this,r=new s((function(e,r){n.ready().then((function(){O(n._dbInfo,"readonly",(function(i,o){if(i)return r(i);try{var s=o.objectStore(n._dbInfo.storeName).openCursor(),a=1;s.onsuccess=function(){var n=s.result;if(n){var r=n.value;_(r)&&(r=S(r));var i=t(r,n.key,a++);void 0!==i?e(i):n.continue()}else e()},s.onerror=function(){r(s.error)}}catch(t){r(t)}}))})).catch(r)}));return a(r,e),r},getItem:function(t,e){var n=this;t=u(t);var r=new s((function(e,r){n.ready().then((function(){O(n._dbInfo,"readonly",(function(i,o){if(i)return r(i);try{var s=o.objectStore(n._dbInfo.storeName).get(t);s.onsuccess=function(){var t=s.result;void 0===t&&(t=null),_(t)&&(t=S(t)),e(t)},s.onerror=function(){r(s.error)}}catch(t){r(t)}}))})).catch(r)}));return a(r,e),r},setItem:function(t,e,n){var r=this;t=u(t);var i=new s((function(n,i){var o;r.ready().then((function(){return o=r._dbInfo,"[object Blob]"===d.call(e)?p(o.db).then((function(t){return t?e:(n=e,new s((function(t,e){var r=new FileReader;r.onerror=e,r.onloadend=function(e){var r=btoa(e.target.result||"");t({__local_forage_encoded_blob:!0,data:r,type:n.type})},r.readAsBinaryString(n)})));var n})):e})).then((function(e){O(r._dbInfo,"readwrite",(function(o,s){if(o)return i(o);try{var a=s.objectStore(r._dbInfo.storeName);null===e&&(e=void 0);var c=a.put(e,t);s.oncomplete=function(){void 0===e&&(e=null),n(e)},s.onabort=s.onerror=function(){var t=c.error?c.error:c.transaction.error;i(t)}}catch(t){i(t)}}))})).catch(i)}));return a(i,n),i},removeItem:function(t,e){var n=this;t=u(t);var r=new s((function(e,r){n.ready().then((function(){O(n._dbInfo,"readwrite",(function(i,o){if(i)return r(i);try{var s=o.objectStore(n._dbInfo.storeName).delete(t);o.oncomplete=function(){e()},o.onerror=function(){r(s.error)},o.onabort=function(){var t=s.error?s.error:s.transaction.error;r(t)}}catch(t){r(t)}}))})).catch(r)}));return a(r,e),r},clear:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){O(e._dbInfo,"readwrite",(function(r,i){if(r)return n(r);try{var o=i.objectStore(e._dbInfo.storeName).clear();i.oncomplete=function(){t()},i.onabort=i.onerror=function(){var t=o.error?o.error:o.transaction.error;n(t)}}catch(t){n(t)}}))})).catch(n)}));return a(n,t),n},length:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){O(e._dbInfo,"readonly",(function(r,i){if(r)return n(r);try{var o=i.objectStore(e._dbInfo.storeName).count();o.onsuccess=function(){t(o.result)},o.onerror=function(){n(o.error)}}catch(t){n(t)}}))})).catch(n)}));return a(n,t),n},key:function(t,e){var n=this,r=new s((function(e,r){t<0?e(null):n.ready().then((function(){O(n._dbInfo,"readonly",(function(i,o){if(i)return r(i);try{var s=o.objectStore(n._dbInfo.storeName),a=!1,c=s.openKeyCursor();c.onsuccess=function(){var n=c.result;n?0===t||a?e(n.key):(a=!0,n.advance(t)):e(null)},c.onerror=function(){r(c.error)}}catch(t){r(t)}}))})).catch(r)}));return a(r,e),r},keys:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){O(e._dbInfo,"readonly",(function(r,i){if(r)return n(r);try{var o=i.objectStore(e._dbInfo.storeName).openKeyCursor(),s=[];o.onsuccess=function(){var e=o.result;e?(s.push(e.key),e.continue()):t(s)},o.onerror=function(){n(o.error)}}catch(t){n(t)}}))})).catch(n)}));return a(n,t),n},dropInstance:function(t,e){e=h.apply(this,arguments);var n=this.config();(t="function"!=typeof t&&t||{}).name||(t.name=t.name||n.name,t.storeName=t.storeName||n.storeName);var r,o=this;if(t.name){var c=t.name===n.name&&o._dbInfo.db,u=c?s.resolve(o._dbInfo.db):b(t).then((function(e){var n=f[t.name],r=n.forages;n.db=e;for(var i=0;i<r.length;i++)r[i]._dbInfo.db=e;return e}));r=t.storeName?u.then((function(e){if(e.objectStoreNames.contains(t.storeName)){var n=e.version+1;g(t);var r=f[t.name],o=r.forages;e.close();for(var a=0;a<o.length;a++){var c=o[a];c._dbInfo.db=null,c._dbInfo.version=n}return new s((function(e,r){var o=i.open(t.name,n);o.onerror=function(t){o.result.close(),r(t)},o.onupgradeneeded=function(){o.result.deleteObjectStore(t.storeName)},o.onsuccess=function(){var t=o.result;t.close(),e(t)}})).then((function(t){r.db=t;for(var e=0;e<o.length;e++){var n=o[e];n._dbInfo.db=t,y(n._dbInfo)}})).catch((function(e){throw(v(t,e)||s.resolve()).catch((function(){})),e}))}})):u.then((function(e){g(t);var n=f[t.name],r=n.forages;e.close();for(var o=0;o<r.length;o++)r[o]._dbInfo.db=null;return new s((function(e,n){var r=i.deleteDatabase(t.name);r.onerror=r.onblocked=function(t){var e=r.result;e&&e.close(),n(t)},r.onsuccess=function(){var t=r.result;t&&t.close(),e(t)}})).then((function(t){n.db=t;for(var e=0;e<r.length;e++)y(r[e]._dbInfo)})).catch((function(e){throw(v(t,e)||s.resolve()).catch((function(){})),e}))}))}else r=s.reject("Invalid arguments");return a(r,e),r}},j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",E=/^~~local_forage_type~([^~]+)~/,M="__lfsc__:".length,P=M+"arbf".length,A=Object.prototype.toString;function C(t){var e,n,r,i,o,s=.75*t.length,a=t.length,c=0;"="===t[t.length-1]&&(s--,"="===t[t.length-2]&&s--);var u=new ArrayBuffer(s),h=new Uint8Array(u);for(e=0;e<a;e+=4)n=j.indexOf(t[e]),r=j.indexOf(t[e+1]),i=j.indexOf(t[e+2]),o=j.indexOf(t[e+3]),h[c++]=n<<2|r>>4,h[c++]=(15&r)<<4|i>>2,h[c++]=(3&i)<<6|63&o;return u}function N(t){var e,n=new Uint8Array(t),r="";for(e=0;e<n.length;e+=3)r+=j[n[e]>>2],r+=j[(3&n[e])<<4|n[e+1]>>4],r+=j[(15&n[e+1])<<2|n[e+2]>>6],r+=j[63&n[e+2]];return n.length%3==2?r=r.substring(0,r.length-1)+"=":n.length%3==1&&(r=r.substring(0,r.length-2)+"=="),r}var B={serialize:function(t,e){var n="";if(t&&(n=A.call(t)),t&&("[object ArrayBuffer]"===n||t.buffer&&"[object ArrayBuffer]"===A.call(t.buffer))){var r,i="__lfsc__:";t instanceof ArrayBuffer?(r=t,i+="arbf"):(r=t.buffer,"[object Int8Array]"===n?i+="si08":"[object Uint8Array]"===n?i+="ui08":"[object Uint8ClampedArray]"===n?i+="uic8":"[object Int16Array]"===n?i+="si16":"[object Uint16Array]"===n?i+="ur16":"[object Int32Array]"===n?i+="si32":"[object Uint32Array]"===n?i+="ui32":"[object Float32Array]"===n?i+="fl32":"[object Float64Array]"===n?i+="fl64":e(new Error("Failed to get type for BinaryArray"))),e(i+N(r))}else if("[object Blob]"===n){var o=new FileReader;o.onload=function(){var n="~~local_forage_type~"+t.type+"~"+N(this.result);e("__lfsc__:blob"+n)},o.readAsArrayBuffer(t)}else try{e(JSON.stringify(t))}catch(n){console.error("Couldn't convert value into a JSON string: ",t),e(null,n)}},deserialize:function(t){if("__lfsc__:"!==t.substring(0,M))return JSON.parse(t);var e,n=t.substring(P),r=t.substring(M,P);if("blob"===r&&E.test(n)){var i=n.match(E);e=i[1],n=n.substring(i[0].length)}var s=C(n);switch(r){case"arbf":return s;case"blob":return o([s],{type:e});case"si08":return new Int8Array(s);case"ui08":return new Uint8Array(s);case"uic8":return new Uint8ClampedArray(s);case"si16":return new Int16Array(s);case"ur16":return new Uint16Array(s);case"si32":return new Int32Array(s);case"ui32":return new Uint32Array(s);case"fl32":return new Float32Array(s);case"fl64":return new Float64Array(s);default:throw new Error("Unkown type: "+r)}},stringToBuffer:C,bufferToString:N};function R(t,e,n,r){t.executeSql("CREATE TABLE IF NOT EXISTS "+e.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,r)}function T(t,e,n,r,i,o){t.executeSql(n,r,i,(function(t,s){s.code===s.SYNTAX_ERR?t.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[e.storeName],(function(t,a){a.rows.length?o(t,s):R(t,e,(function(){t.executeSql(n,r,i,o)}),o)}),o):o(t,s)}),o)}function W(t,e,n,r){var i=this;t=u(t);var o=new s((function(o,s){i.ready().then((function(){void 0===e&&(e=null);var a=e,c=i._dbInfo;c.serializer.serialize(e,(function(e,u){u?s(u):c.db.transaction((function(n){T(n,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[t,e],(function(){o(a)}),(function(t,e){s(e)}))}),(function(e){if(e.code===e.QUOTA_ERR){if(r>0)return void o(W.apply(i,[t,a,n,r-1]));s(e)}}))}))})).catch(s)}));return a(o,n),o}function L(t){return new s((function(e,n){t.transaction((function(r){r.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(n,r){for(var i=[],o=0;o<r.rows.length;o++)i.push(r.rows.item(o).name);e({db:t,storeNames:i})}),(function(t,e){n(e)}))}),(function(t){n(t)}))}))}var D={_driver:"webSQLStorage",_initStorage:function(t){var e=this,n={db:null};if(t)for(var r in t)n[r]="string"!=typeof t[r]?t[r].toString():t[r];var i=new s((function(t,r){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(t){return r(t)}n.db.transaction((function(i){R(i,n,(function(){e._dbInfo=n,t()}),(function(t,e){r(e)}))}),r)}));return n.serializer=B,i},_support:"function"==typeof openDatabase,iterate:function(t,e){var n=this,r=new s((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){T(n,i,"SELECT * FROM "+i.storeName,[],(function(n,r){for(var o=r.rows,s=o.length,a=0;a<s;a++){var c=o.item(a),u=c.value;if(u&&(u=i.serializer.deserialize(u)),void 0!==(u=t(u,c.key,a+1)))return void e(u)}e()}),(function(t,e){r(e)}))}))})).catch(r)}));return a(r,e),r},getItem:function(t,e){var n=this;t=u(t);var r=new s((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){T(n,i,"SELECT * FROM "+i.storeName+" WHERE key = ? LIMIT 1",[t],(function(t,n){var r=n.rows.length?n.rows.item(0).value:null;r&&(r=i.serializer.deserialize(r)),e(r)}),(function(t,e){r(e)}))}))})).catch(r)}));return a(r,e),r},setItem:function(t,e,n){return W.apply(this,[t,e,n,1])},removeItem:function(t,e){var n=this;t=u(t);var r=new s((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){T(n,i,"DELETE FROM "+i.storeName+" WHERE key = ?",[t],(function(){e()}),(function(t,e){r(e)}))}))})).catch(r)}));return a(r,e),r},clear:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){T(e,r,"DELETE FROM "+r.storeName,[],(function(){t()}),(function(t,e){n(e)}))}))})).catch(n)}));return a(n,t),n},length:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){T(e,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],(function(e,n){var r=n.rows.item(0).c;t(r)}),(function(t,e){n(e)}))}))})).catch(n)}));return a(n,t),n},key:function(t,e){var n=this,r=new s((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){T(n,i,"SELECT key FROM "+i.storeName+" WHERE id = ? LIMIT 1",[t+1],(function(t,n){var r=n.rows.length?n.rows.item(0).key:null;e(r)}),(function(t,e){r(e)}))}))})).catch(r)}));return a(r,e),r},keys:function(t){var e=this,n=new s((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){T(e,r,"SELECT key FROM "+r.storeName,[],(function(e,n){for(var r=[],i=0;i<n.rows.length;i++)r.push(n.rows.item(i).key);t(r)}),(function(t,e){n(e)}))}))})).catch(n)}));return a(n,t),n},dropInstance:function(t,e){e=h.apply(this,arguments);var n=this.config();(t="function"!=typeof t&&t||{}).name||(t.name=t.name||n.name,t.storeName=t.storeName||n.storeName);var r,i=this;return a(r=t.name?new s((function(e){var r;r=t.name===n.name?i._dbInfo.db:openDatabase(t.name,"","",0),t.storeName?e({db:r,storeNames:[t.storeName]}):e(L(r))})).then((function(t){return new s((function(e,n){t.db.transaction((function(r){function i(t){return new s((function(e,n){r.executeSql("DROP TABLE IF EXISTS "+t,[],(function(){e()}),(function(t,e){n(e)}))}))}for(var o=[],a=0,c=t.storeNames.length;a<c;a++)o.push(i(t.storeNames[a]));s.all(o).then((function(){e()})).catch((function(t){n(t)}))}),(function(t){n(t)}))}))})):s.reject("Invalid arguments"),e),r}};function X(t,e){var n=t.name+"/";return t.storeName!==e.storeName&&(n+=t.storeName+"/"),n}function z(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(t){return!0}}()||localStorage.length>0}var Y={_driver:"localStorageWrapper",_initStorage:function(t){var e={};if(t)for(var n in t)e[n]=t[n];return e.keyPrefix=X(t,this._defaultConfig),z()?(this._dbInfo=e,e.serializer=B,s.resolve()):s.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(t){return!1}}(),iterate:function(t,e){var n=this,r=n.ready().then((function(){for(var e=n._dbInfo,r=e.keyPrefix,i=r.length,o=localStorage.length,s=1,a=0;a<o;a++){var c=localStorage.key(a);if(0===c.indexOf(r)){var u=localStorage.getItem(c);if(u&&(u=e.serializer.deserialize(u)),void 0!==(u=t(u,c.substring(i),s++)))return u}}}));return a(r,e),r},getItem:function(t,e){var n=this;t=u(t);var r=n.ready().then((function(){var e=n._dbInfo,r=localStorage.getItem(e.keyPrefix+t);return r&&(r=e.serializer.deserialize(r)),r}));return a(r,e),r},setItem:function(t,e,n){var r=this;t=u(t);var i=r.ready().then((function(){void 0===e&&(e=null);var n=e;return new s((function(i,o){var s=r._dbInfo;s.serializer.serialize(e,(function(e,r){if(r)o(r);else try{localStorage.setItem(s.keyPrefix+t,e),i(n)}catch(t){"QuotaExceededError"!==t.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||o(t),o(t)}}))}))}));return a(i,n),i},removeItem:function(t,e){var n=this;t=u(t);var r=n.ready().then((function(){var e=n._dbInfo;localStorage.removeItem(e.keyPrefix+t)}));return a(r,e),r},clear:function(t){var e=this,n=e.ready().then((function(){for(var t=e._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var r=localStorage.key(n);0===r.indexOf(t)&&localStorage.removeItem(r)}}));return a(n,t),n},length:function(t){var e=this.keys().then((function(t){return t.length}));return a(e,t),e},key:function(t,e){var n=this,r=n.ready().then((function(){var e,r=n._dbInfo;try{e=localStorage.key(t)}catch(t){e=null}return e&&(e=e.substring(r.keyPrefix.length)),e}));return a(r,e),r},keys:function(t){var e=this,n=e.ready().then((function(){for(var t=e._dbInfo,n=localStorage.length,r=[],i=0;i<n;i++){var o=localStorage.key(i);0===o.indexOf(t.keyPrefix)&&r.push(o.substring(t.keyPrefix.length))}return r}));return a(n,t),n},dropInstance:function(t,e){if(e=h.apply(this,arguments),!(t="function"!=typeof t&&t||{}).name){var n=this.config();t.name=t.name||n.name,t.storeName=t.storeName||n.storeName}var r,i=this;return a(r=t.name?new s((function(e){t.storeName?e(X(t,i._defaultConfig)):e(t.name+"/")})).then((function(t){for(var e=localStorage.length-1;e>=0;e--){var n=localStorage.key(e);0===n.indexOf(t)&&localStorage.removeItem(n)}})):s.reject("Invalid arguments"),e),r}},H=function(t,e){for(var n,r,i=t.length,o=0;o<i;){if((n=t[o])===(r=e)||"number"==typeof n&&"number"==typeof r&&isNaN(n)&&isNaN(r))return!0;o++}return!1},F=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},q={},G={},U={INDEXEDDB:I,WEBSQL:D,LOCALSTORAGE:Y},V=[U.INDEXEDDB._driver,U.WEBSQL._driver,U.LOCALSTORAGE._driver],J=["dropInstance"],K=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(J),Q={description:"",driver:V.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Z(t,e){t[e]=function(){var n=arguments;return t.ready().then((function(){return t[e].apply(t,n)}))}}function $(){for(var t=1;t<arguments.length;t++){var e=arguments[t];if(e)for(var n in e)e.hasOwnProperty(n)&&(F(e[n])?arguments[0][n]=e[n].slice():arguments[0][n]=e[n])}return arguments[0]}var tt=new(function(){function t(e){for(var n in function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),U)if(U.hasOwnProperty(n)){var r=U[n],i=r._driver;this[n]=i,q[i]||this.defineDriver(r)}this._defaultConfig=$({},Q),this._config=$({},this._defaultConfig,e),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return t.prototype.config=function(t){if("object"===(void 0===t?"undefined":r(t))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var e in t){if("storeName"===e&&(t[e]=t[e].replace(/\W/g,"_")),"version"===e&&"number"!=typeof t[e])return new Error("Database version must be a number.");this._config[e]=t[e]}return!("driver"in t)||!t.driver||this.setDriver(this._config.driver)}return"string"==typeof t?this._config[t]:this._config},t.prototype.defineDriver=function(t,e,n){var r=new s((function(e,n){try{var r=t._driver,i=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver)return void n(i);for(var o=K.concat("_initStorage"),c=0,u=o.length;c<u;c++){var h=o[c];if((!H(J,h)||t[h])&&"function"!=typeof t[h])return void n(i)}!function(){for(var e=function(t){return function(){var e=new Error("Method "+t+" is not implemented by the current driver"),n=s.reject(e);return a(n,arguments[arguments.length-1]),n}},n=0,r=J.length;n<r;n++){var i=J[n];t[i]||(t[i]=e(i))}}();var l=function(n){q[r]&&console.info("Redefining LocalForage driver: "+r),q[r]=t,G[r]=n,e()};"_support"in t?t._support&&"function"==typeof t._support?t._support().then(l,n):l(!!t._support):l(!0)}catch(t){n(t)}}));return c(r,e,n),r},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(t,e,n){var r=q[t]?s.resolve(q[t]):s.reject(new Error("Driver not found."));return c(r,e,n),r},t.prototype.getSerializer=function(t){var e=s.resolve(B);return c(e,t),e},t.prototype.ready=function(t){var e=this,n=e._driverSet.then((function(){return null===e._ready&&(e._ready=e._initDriver()),e._ready}));return c(n,t,t),n},t.prototype.setDriver=function(t,e,n){var r=this;F(t)||(t=[t]);var i=this._getSupportedDrivers(t);function o(){r._config.driver=r.driver()}function a(t){return r._extend(t),o(),r._ready=r._initStorage(r._config),r._ready}var u=null!==this._driverSet?this._driverSet.catch((function(){return s.resolve()})):s.resolve();return this._driverSet=u.then((function(){var t=i[0];return r._dbInfo=null,r._ready=null,r.getDriver(t).then((function(t){r._driver=t._driver,o(),r._wrapLibraryMethodsWithReady(),r._initDriver=function(t){return function(){var e=0;return function n(){for(;e<t.length;){var i=t[e];return e++,r._dbInfo=null,r._ready=null,r.getDriver(i).then(a).catch(n)}o();var c=new Error("No available storage method found.");return r._driverSet=s.reject(c),r._driverSet}()}}(i)}))})).catch((function(){o();var t=new Error("No available storage method found.");return r._driverSet=s.reject(t),r._driverSet})),c(this._driverSet,e,n),this._driverSet},t.prototype.supports=function(t){return!!G[t]},t.prototype._extend=function(t){$(this,t)},t.prototype._getSupportedDrivers=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];this.supports(i)&&e.push(i)}return e},t.prototype._wrapLibraryMethodsWithReady=function(){for(var t=0,e=K.length;t<e;t++)Z(this,K[t])},t.prototype.createInstance=function(e){return new t(e)},t}());e.exports=tt},{3:3}]},{},[4])(4)})),Z=function(t){function n(e){var n=t.call(this)||this;return n.databaseName=e,n.stores=new Map,n}return e(n,t),n.prototype.open=function(t){return r(this,void 0,void 0,(function(){var e,n;return i(this,(function(r){return this.stores.has(t)?[2,this.stores.get(t)]:(e=Q.createInstance({driver:[Q.INDEXEDDB,Q.LOCALSTORAGE],name:this.databaseName,storeName:t}),n=new G(e),this.stores.set(t,n),[2,n])}))}))},n}(u),$=function(t){function n(){var e=t.call(this,"light-engine:save-db")||this;return e.temp=new Z("light-engine:temp-save-db"),e}return e(n,t),n}(Z),tt=function(t){function n(e,n){var r=t.call(this)||this;return r.list=[],r.game=e,r.list=n.map((function(t){return t instanceof X?t.setGame(r.game).setManager(r):new t({name:t.name}).setGame(r.game).setManager(r)})),r}return e(n,t),n.create=function(t){return function(e){return new n(e,t)}},n.prototype.add=function(t){return this.list=o(t instanceof X?[t.setGame(this.game).setManager(this)]:[new t({name:t.name}).setGame(this.game).setManager(this)],this.list),this},n.prototype.getFirst=function(){return this.getScene(0)},n.prototype.getLast=function(){return this.getScene(this.list.length-1)},n.prototype.play=function(t){return this.game.playScene(this.getScene(t))},n.prototype.playWithOpacity=function(t,e){var n="object"==typeof t?t:this.getScene(t);return n.played=!0,n.isPlayed="opacity",n.alpha=x(e,1),this.game.playedWithOpacity.includes(n)||(this.game.playedWithOpacity=o(this.game.playedWithOpacity,[n])),n},n.prototype.getScene=function(t){if("string"==typeof t){if(e=this.list.find((function(e){return e.name===t})))return e;this.globals.emit("w"+y.Scene,"this scene "+t+" is not create")}else if("number"==typeof t){var e;if(e=this.list[t])return e;this.globals.emit("w"+y.Scene,"the "+t+(("1"===(r=(n=t).toString().split(""))[r.length-1]?n+"st":"2"===r[r.length-1]?n+"nd":"3"===r[r.length-1]?n+"rd":n+"th")+" scene has not been created"))}else if("object"==typeof t)return t;var n,r;return this.list[0]},n.prototype.getScenes=function(t){return void 0===t&&(t=function(t){return!0}),this.list.filter(t)},n}(u),et=Object.freeze({__proto__:null,AudioManager:l,ContainerManager:I,EntityManager:V,Manager:u,SaveManager:$,SceneManager:tt}),nt=function(){function t(t,e){this.isPlaying=!1,this.frame=-1,this.loop=this.loop.bind(this),this.callback=e,this.delay=1e3/t}return t.prototype.loop=function(t){_(this.time)||(this.time=t);var e=Math.floor((t-this.time)/this.delay);e>this.frame&&(this.frame=e,this.callback({time:t,frame:this.frame})),this.tref=requestAnimationFrame(this.loop)},t.prototype.frameRate=function(t){var e=1e3*this.delay;if(!arguments.length)return e;this.delay=1e3/t,this.frame=-1,this.time=null},t.prototype.start=function(){this.isPlaying||(this.isPlaying=!0,this.tref=requestAnimationFrame(this.loop))},t.prototype.pause=function(){this.isPlaying&&(cancelAnimationFrame(this.tref),this.isPlaying=!1,this.time=null,this.frame=-1)},t}(),rt=function(t){function n(e,n,r,i,o){var s;void 0===n&&(n=800),void 0===r&&(r=600),void 0===i&&(i=document),void 0===o&&(o=window);var a=t.call(this)||this;a.doc=i,a.win=o,a.secondsPassed=0,a.oldTimeStamp=0,a.inited=[],u.createType("Entity"),w.set("development",null!==(s=e.dev)&&void 0!==s&&s),a.audioContext=new AudioContext,a.playedWithOpacity=[],a.state=new f,a.debug=e.debug,a.pixel=e.pixel,a.update=a.update.bind(a),a.initScene=a.initScene.bind(a),a.canvas="object"==typeof e.canvas&&e.canvas instanceof HTMLCanvasElement?e.canvas:a.doc.body.appendChild(a.doc.createElement("canvas"));var c=a.canvas.parentNode;a.w=x(n,c.clientWidth),a.h=x(r,c.clientHeight),a.canvas.width=a.w,a.canvas.height=a.h;var h=a.w,l=a.h;"string"==typeof n&&n.trim().endsWith("%")&&"string"==typeof r&&r.trim().endsWith("%")&&a.globals.on("window:resize",(function(){"string"==typeof n&&n.trim().endsWith("%")&&h!==c.clientWidth&&(a.w=x(n,c.clientWidth),a.canvas.width=a.w),"string"==typeof r&&r.trim().endsWith("%")&&l!==c.clientHeight&&(a.h=x(r,c.clientHeight),a.canvas.height=a.h)})),e.pixel&&(a.canvas.style.imageRendering="Google Inc."===navigator.vendor?"pixelated":"crisp-edges"),a.context=a.canvas.getContext("2d"),a.sceneManager=e.scene(a);var d=Object.keys(e.load||{}),p=null;if("undefined"!==k(e.loadScene)){var g=e.loadScene.forcedLoadingOfEntities||[];d=d.filter((function(t){return!g.includes(t)})),g.forEach((function(t){e.load[t].then((function(e){return V.addMedia(t,e)})).catch((function(t){return a.globals.emit("e"+v.Load,t)}))})),p=a.sceneManager.add(e.loadScene).play(0),a.initScene(p),p.on("progress",(function(t){1===t&&p.emit("progress:ended")}))}for(var y=function(t){var n=d[t];e.load[n].then((function(e){V.addMedia(n,e),p&&p.emit("progress",(t+1)/d.length)})).catch((function(t){return a.globals.emit("e"+v.Load,t)}))},m=0;m<d.length;m++)y(m);return p||a.sceneManager.play(0),a.loop=new nt(240,a.update),a.mouse=new z(a),a.keyboard=new F,a.gamepad=new q,a.save=new $,a.eventsAndErrors(),a}return e(n,t),n.prototype.changeScene=function(t){var e=this.sceneManager.getScene(t);return(!_(this.currentScene)||this.currentScene.changeAllow(e,g.Next)||_(e)&&e.changeAllow(this.currentScene,g.Prev))&&(e.emit("called",this.currentScene),this.currentScene&&(this.currentScene.played=!1,this.currentScene.isPlayed="none"),e.played=!0,e.isPlayed="main",this.currentScene=e,this.playedWithOpacity=[]),this.currentScene},n.prototype.playScene=function(t){return this.changeScene(t)},n.prototype.getStateSave=function(t){var e=Object.assign({},{entityProperties:[],over:{},exclude:{}},t);return e.exclude=Object.assign({},{scenes:[],entities:[]},null==t?void 0:t.exclude),JSON.stringify({kle_id:navigator.platform+":"+navigator.productSub,over:e.over,scenes:{played:this.currentScene.toJSON(e),opacity:this.playedWithOpacity.filter((function(t){return!e.exclude.scenes.includes(t.name)})).map((function(t){return t.toJSON(e)})),not_played:this.sceneManager.getScenes((function(t){return!t.played&&!e.exclude.scenes.includes(t.name)})).map((function(t){return t.toJSON(e)}))}})},n.prototype.setStateSave=function(t,e){var n=this;void 0===e&&(e=!1);var r=JSON.parse(t);e&&r.kle_id===navigator.platform+":"+navigator.productSub&&this.globals.emit("e"+v.ClientKey,"the kle_id doesn't match with the client instance");var i=this.sceneManager.getScenes().find((function(t){return t.name===r.scenes.played.name}));i&&(this.playScene(i),i.fromSave(r.scenes.played),this.sceneManager.getScenes((function(t){return t!==i})).forEach((function(t){var e=r.scenes.opacity.find((function(e){return e.name===t.name}));if(e)return n.sceneManager.playWithOpacity(t,e.alpha),t.fromSave(e),null;var i=r.scenes.not_played.find((function(e){return e.name===t.name}));i&&t.fromSave(i)})))},n.prototype.initScene=function(t){if(!this.inited.includes(t.init)){this.inited=o(this.inited,[t.init]),w.set("currentObject",t),t.hookIndex=0,t.init();for(var e=0,n=t.entities.getAll();e<n.length;e++){var r=n[e];w.set("currentObject",r),r.hookIndex=0,r.init()}for(var i=0,s=t.managers.getAllType("Entity");i<s.length;i++){var a=s[i];w.set("currentObject",a),a.hookIndex=0,a.init(t)}}if("main"===t.isPlayed)for(var c=0,u=this.playedWithOpacity;c<u.length;c++){var h=u[c];this.initScene(h)}},n.prototype.update=function(t){this.initScene(this.currentScene);var e=this.currentScene.entities.getAll();this.setFPS(t.time),this.mouse.update(),this.globals.emit("updated"),this.globals.emit("window:resize"),w.set("currentObject",this.currentScene),this.currentScene.hookIndex=0,this.currentScene.beforeUpdate();for(var n=0,r=e;n<r.length;n++){(p=r[n]).collide(this.mouse)&&p.emit("mouse:hover"),p.collide(this.mouse)&&this.mouse.click&&p.emit("mouse:click"),w.set("currentObject",p),p.hookIndex=0,p.beforeRedraw(),p.redraw(this.secondsPassed),p.emit("move:velocity",p)}for(var i=0,o=this.playedWithOpacity;i<o.length;i++){var s=(v=o[i]).entities.getAll();w.set("currentObject",v),v.hookIndex=0,v.beforeUpdate();for(var a=0,c=s;a<c.length;a++){(p=c[a]).collide(this.mouse)&&p.emit("mouse:hover"),p.collide(this.mouse)&&this.mouse.click&&p.emit("mouse:click"),w.set("currentObject",p),p.hookIndex=0,p.beforeRedraw(),p.redraw(this.secondsPassed),p.emit("move:velocity",p)}}for(var u=0,h=this.currentScene.managers.getAllType("Entity");u<h.length;u++){var l=h[u];w.set("currentObject",l),l.hookIndex=0,l.update()}this.context.clearRect(0,0,this.w,this.h),this.context.save(),this.context.globalAlpha=1,this.context.fillStyle="#000",this.context.fillRect(0,0,this.w,this.h),this.context.restore(),this.pixel&&(this.context.imageSmoothingEnabled=!1,this.context.imageSmoothingQuality="high");for(var f=0,d=e;f<d.length;f++){var p=d[f];w.set("currentObject",p),p.hidden||p.draw(this.context),p.afterRedraw()}for(var g=0,y=this.playedWithOpacity;g<y.length;g++){for(var v,m=0,b=(v=y[g]).entities.getAll();m<b.length;m++){p=b[m];w.set("currentObject",p),p.hidden||p.draw(this.context),p.afterRedraw()}w.set("currentObject",v),v.update(this.secondsPassed),v.afterUpdate()}this.context.globalAlpha=1,this.mouse.draw(this.context),w.set("currentObject",this.currentScene),this.currentScene.update(this.secondsPassed),this.currentScene.afterUpdate()},n.prototype.setFPS=function(t){this.secondsPassed=(t-this.oldTimeStamp)/1e3,this.oldTimeStamp=t,this.fps=Math.round(1/this.secondsPassed)},n.prototype.eventsAndErrors=function(){var t=this,e=new a;this.doc.addEventListener("visibilitychange",(function(){return e.emit("page:visibilitychange")})),this.win.addEventListener("load",(function(){t.loop.start()})),this.win.addEventListener("keydown",(function(t){e.emit("key:down",t.key)})),this.win.addEventListener("keyup",(function(t){e.emit("key:up",t.key)})),this.win.addEventListener("gamepadconnected",(function(t){e.emit("gamepad:add",t)})),this.win.addEventListener("gamepaddisconnected",(function(t){e.emit("gamepad:remove",t)}));var n=function(t){/\d/.test(t)&&e.on("e"+t,(function(e){return console.error("["+v[t]+"]: "+e)}))};for(var r in v)n(r);var i=function(t){/\d/.test(t)&&e.on("w"+t,(function(e){return console.warn("["+y[t]+"]: "+e)}))};for(var r in y)i(r)},n}(c);var it=Object.freeze({__proto__:null,Image:function(t){return new Promise((function(e,n){var r=document.createElement("img");r.src=t,r.onload=function(){return e(r)},r.onerror=n}))},Audio:function(t){return new Promise((function(e,n){var r=new j(t);r.on("loadeddata",(function(){return e(r)})),r.on("error",n)}))},Text:function(t){return new Promise((function(e,n){e(document.createTextNode(t))}))},DOM:function(t){return new Promise((function(e,n){t instanceof HTMLImageElement&&!t.complete||t instanceof HTMLMediaElement&&t.readyState<2?(t.onloadeddata=function(){return e(t)},t.onerror=n):e(t)}))}});function ot(t,e){var n=w.get("currentObject"),r=n.hooks&&n.hooks[n.hookIndex],i={memo:r?r.memo:t(),hooks:r?r.hooks:[],hookIndex:r?r.hookIndex:0,dependencies:r?r.dependencies:e};return n.hooks[n.hookIndex]=i,O(i.dependencies,e)&&(w.set("currentObject",i),i.hookIndex=0,i.memo=t(),i.dependencies=e,w.set("currentObject",n)),n.hookIndex++,i.memo}var st=Object.freeze({__proto__:null,useState:function(t){var e=w.get("currentObject"),n=e.hooks&&e.hooks[e.hookIndex],r={state:n?n.state:t};return e.hooks[e.hookIndex]=r,e.hookIndex++,[r.state,function(t){r.state="function"==typeof t?t(r.state):t}]},useMemo:ot,useCallback:function(t,e){return ot((function(){return t}),e)},useEffect:function(t,e){var n=w.get("currentObject"),r=n.hooks&&n.hooks[n.hookIndex],i={cleanerFn:r?r.cleanerFn:t(),hooks:r?r.hooks:[],hookIndex:r?r.hookIndex:0,dependencies:r?r.dependencies:e};n.hooks[n.hookIndex]=i,O(i.dependencies,e)&&(w.set("currentObject",i),i.hookIndex=0,_(i.cleanerFn)&&i.cleanerFn(),i.cleanerFn=t(),i.dependencies=e,w.set("currentObject",n)),n.hookIndex++},useTimer:function(t,e,n){void 0===n&&(n=[]);var r=w.get("currentObject");if(r instanceof u)return console.error("[useTimer]: is not allowed in a Manger");var i=r instanceof P?r.scene:r,o=r.hooks&&r.hooks[r.hookIndex],s={hooks:o?o.hooks:[],hookIndex:0};return r.hooks[r.hookIndex]=s,r.hookIndex++,ot((function(){var n=i.create.timer((function(){w.set("currentObject",s),s.hookIndex=0,t(),w.set("currentObject",r)}),{time:e});return n.play(),n}),n)},useTick:function(t,e,n){void 0===n&&(n=[]);var r=w.get("currentObject");if(r instanceof u)return console.error("[useTick]: is not allowed in a Manger");var i=r instanceof P?r.scene:r,o=r.hooks&&r.hooks[r.hookIndex],s={hooks:o?o.hooks:[],hookIndex:0};return r.hooks[r.hookIndex]=s,r.hookIndex++,ot((function(){var n=i.create.timer((function(){w.set("currentObject",s),s.hookIndex=0,t(),w.set("currentObject",r)}),{tick:e});return n.play(),n}),n)}});exports.EventEmitter=c,exports.Game=rt,exports.Hooks=st,exports.Loaders=it,exports.Managers=et,exports.Objects=U;
